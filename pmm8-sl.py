# -*- coding: utf-8 -*-
"""SL-PMM8.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1xKKlqz0T6HuRlNamCwkcwLxeMS-WY3ZD
"""

#colab update
from google.colab import files
# ä¸Šå‚³CSV
uploaded = files.upload()

import pandas as pd
import yfinance as yf

# âœ… åªè™•ç†è‚¡ç¥¨åˆ†å‰²çš„äº‹ä»¶è™•ç†é¡åˆ¥
class StockEventProcessor:
    def __init__(self):
        self.events_data = {}

    def fetch_stock_events(self, ticker, start_date, end_date):
        """
        æŠ“å–è‚¡ç¥¨åˆ†å‰²äº‹ä»¶è³‡æ–™ï¼Œä½¿ç”¨ yfinance.actions ä¸­çš„ Stock Splits æ¬„ä½
        """
        events = {
            'splits': []
        }

        try:
            stock = yf.Ticker(ticker)

            actions = stock.actions.reset_index()
            actions["Date"] = actions["Date"].dt.tz_localize(None)

            actions = actions[
                (actions["Date"] >= start_date) &
                (actions["Date"] <= end_date)
            ].copy()

            # âœ… è™•ç†è‚¡ç¥¨åˆ†å‰²
            splits_df = actions[actions["Stock Splits"] > 0][["Date", "Stock Splits"]]
            splits_df.columns = ["Date", "Split_Ratio"]
            for _, row in splits_df.iterrows():
                events["splits"].append({
                    "date": row["Date"],
                    "ratio": row["Split_Ratio"],
                    "type": "split"
                })

        except Exception as e:
            print(f"âš ï¸ æŠ“å– {ticker} è‚¡ç¥¨åˆ†å‰²è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{e}")

        self.events_data[ticker] = events
        return events

    def apply_stock_split(self, position_data, ticker, split_date, split_ratio):
        """
        è™•ç†è‚¡ç¥¨åˆ†å‰²äº‹ä»¶
        split_ratio: åˆ†å‰²æ¯”ä¾‹ (ä¾‹å¦‚ 2.0 è¡¨ç¤º 1è‚¡åˆ†å‰²æˆ2è‚¡)
        """
        if ticker in position_data:
            pos = position_data[ticker]

            # èª¿æ•´è‚¡æ•¸èˆ‡å¹³å‡æˆæœ¬
            pos['shares'] *= split_ratio
            pos['avg_cost_foreign'] /= split_ratio

            # é‡æ–°è¨ˆç®—å¹³å‡åŒ¯ç‡æˆæœ¬ï¼ˆç¸½æˆæœ¬ä¸è®Šï¼‰
            if pos['shares'] > 0 and pos["avg_cost_foreign"] > 0:
                pos["avg_exchange_rate"] = pos["total_cost_twd"] / (pos["avg_cost_foreign"] * pos["shares"])

            print(f"âœ… {ticker} è‚¡ç¥¨åˆ†å‰²è™•ç†å®Œæˆ - åˆ†å‰²æ¯”ä¾‹: {split_ratio}, èª¿æ•´å¾Œè‚¡æ•¸: {pos['shares']}")

            return {
                'ticker': ticker,
                'date': split_date,
                'event': 'stock_split',
                'ratio': split_ratio,
                'new_shares': pos['shares'],
                'new_avg_cost': pos['avg_cost_foreign']
            }

import pandas as pd
import yfinance as yf
from datetime import datetime

class StockEventProcessor:
    def __init__(self):
        self.events_data = {}

    def fetch_stock_events(self, ticker, start_date, end_date):
        """
        æŠ“å–è‚¡ç¥¨åˆ†å‰²äº‹ä»¶è³‡æ–™ï¼Œä½¿ç”¨ yfinance.actions ä¸­çš„ Stock Splits æ¬„ä½
        """
        events = {
            'splits': []
        }
        try:
            stock = yf.Ticker(ticker)
            actions = stock.actions.reset_index()
            actions["Date"] = actions["Date"].dt.tz_localize(None)
            actions = actions[
                (actions["Date"] >= start_date) &
                (actions["Date"] <= end_date)
            ].copy()

            # âœ… è™•ç†è‚¡ç¥¨åˆ†å‰²
            splits_df = actions[actions["Stock Splits"] > 0][["Date", "Stock Splits"]]
            splits_df.columns = ["Date", "Split_Ratio"]

            for _, row in splits_df.iterrows():
                events["splits"].append({
                    "date": row["Date"],
                    "ratio": row["Split_Ratio"],
                    "type": "split"
                })
        except Exception as e:
            print(f"âš ï¸ æŠ“å– {ticker} è‚¡ç¥¨åˆ†å‰²è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{e}")

        self.events_data[ticker] = events
        return events

    def apply_stock_split_with_timing(self, position_data, ticker, split_date, split_ratio, transaction_history=None):
        """
        ä¾æ“šæ™‚é–“è™•ç†è‚¡ç¥¨åˆ†å‰²äº‹ä»¶ - åªå°åˆ†å‰²æ—¥æœŸå‰å·²æŒæœ‰çš„è‚¡ç¥¨é€²è¡Œèª¿æ•´

        Args:
            position_data: ç›®å‰æŒå€‰è³‡æ–™
            ticker: è‚¡ç¥¨ä»£ç¢¼
            split_date: åˆ†å‰²æ—¥æœŸ
            split_ratio: åˆ†å‰²æ¯”ä¾‹ (ä¾‹å¦‚ 2.0 è¡¨ç¤º 1è‚¡åˆ†å‰²æˆ2è‚¡)
            transaction_history: äº¤æ˜“æ­·å²è¨˜éŒ„ (åŒ…å«æ—¥æœŸã€è²·è³£ã€è‚¡æ•¸ç­‰)
        """
        if ticker not in position_data:
            print(f"âš ï¸ {ticker} ä¸åœ¨ç›®å‰æŒå€‰ä¸­ï¼Œç„¡éœ€è™•ç†åˆ†å‰²")
            return None

        pos = position_data[ticker]
        original_shares = pos['shares']
        original_avg_cost = pos['avg_cost_foreign']

        # å¦‚æœæœ‰äº¤æ˜“æ­·å²ï¼Œè¨ˆç®—åˆ†å‰²æ—¥å‰çš„æŒè‚¡
        if transaction_history is not None:
            shares_before_split = self._calculate_shares_before_date(
                transaction_history, ticker, split_date
            )

            if shares_before_split <= 0:
                print(f"â„¹ï¸ {ticker} åœ¨åˆ†å‰²æ—¥ {split_date} å‰ç„¡æŒè‚¡ï¼Œç„¡éœ€èª¿æ•´")
                return None

            # åªå°åˆ†å‰²æ—¥å‰çš„æŒè‚¡é€²è¡Œèª¿æ•´
            adjusted_shares_from_split = shares_before_split * (split_ratio - 1)  # å¢åŠ çš„è‚¡æ•¸
            pos['shares'] = original_shares + adjusted_shares_from_split

            # é‡æ–°è¨ˆç®—å¹³å‡æˆæœ¬ï¼ˆè€ƒæ…®åˆ†å‰²å¾Œè‚¡æ•¸å¢åŠ ä½†ç¸½åƒ¹å€¼ä¸è®Šï¼‰
            if pos['shares'] > 0:
                # åˆ†å‰²å‰æŒè‚¡çš„ç¸½æˆæœ¬ä¿æŒä¸è®Šï¼Œä½†è‚¡æ•¸å¢åŠ äº†
                total_cost_before_split = shares_before_split * original_avg_cost
                shares_after_split_from_old = shares_before_split * split_ratio

                # åˆ†å‰²æ—¥å¾Œè²·å…¥çš„è‚¡ç¥¨æˆæœ¬ï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
                shares_after_split_date = original_shares - shares_before_split
                cost_after_split_date = shares_after_split_date * original_avg_cost

                # è¨ˆç®—æ–°çš„å¹³å‡æˆæœ¬
                total_cost = total_cost_before_split + cost_after_split_date
                pos['avg_cost_foreign'] = total_cost / pos['shares']
        else:
            # æ²’æœ‰äº¤æ˜“æ­·å²æ™‚ï¼Œå‡è¨­æ‰€æœ‰æŒè‚¡éƒ½åœ¨åˆ†å‰²æ—¥å‰
            pos['shares'] *= split_ratio
            pos['avg_cost_foreign'] /= split_ratio

        # é‡æ–°è¨ˆç®—å¹³å‡åŒ¯ç‡æˆæœ¬ï¼ˆç¸½æˆæœ¬ä¸è®Šï¼‰
        if pos['shares'] > 0 and pos["avg_cost_foreign"] > 0:
            pos["avg_exchange_rate"] = pos["total_cost_twd"] / (pos["avg_cost_foreign"] * pos["shares"])

        print(f"âœ… {ticker} è‚¡ç¥¨åˆ†å‰²è™•ç†å®Œæˆ")
        print(f"   åˆ†å‰²æ—¥æœŸ: {split_date}")
        print(f"   åˆ†å‰²æ¯”ä¾‹: {split_ratio}")
        print(f"   åŸå§‹è‚¡æ•¸: {original_shares}")
        print(f"   èª¿æ•´å¾Œè‚¡æ•¸: {pos['shares']}")
        print(f"   åŸå§‹å¹³å‡æˆæœ¬: ${original_avg_cost:.4f}")
        print(f"   èª¿æ•´å¾Œå¹³å‡æˆæœ¬: ${pos['avg_cost_foreign']:.4f}")

        return {
            'ticker': ticker,
            'date': split_date,
            'event': 'stock_split',
            'ratio': split_ratio,
            'original_shares': original_shares,
            'new_shares': pos['shares'],
            'original_avg_cost': original_avg_cost,
            'new_avg_cost': pos['avg_cost_foreign']
        }

    def _calculate_shares_before_date(self, transaction_history, ticker, target_date):
        """
        è¨ˆç®—ç‰¹å®šæ—¥æœŸå‰çš„æŒè‚¡æ•¸é‡

        Args:
            transaction_history: äº¤æ˜“æ­·å² DataFrame æˆ– list
            ticker: è‚¡ç¥¨ä»£ç¢¼
            target_date: ç›®æ¨™æ—¥æœŸ
        """
        shares = 0

        if isinstance(transaction_history, pd.DataFrame):
            # DataFrame æ ¼å¼
            ticker_transactions = transaction_history[
                (transaction_history['ticker'] == ticker) &
                (transaction_history['date'] < target_date)
            ]

            for _, row in ticker_transactions.iterrows():
                if row['action'].lower() in ['buy', 'è²·å…¥']:
                    shares += row['shares']
                elif row['action'].lower() in ['sell', 'è³£å‡º']:
                    shares -= row['shares']

        elif isinstance(transaction_history, list):
            # List æ ¼å¼
            for transaction in transaction_history:
                if (transaction.get('ticker') == ticker and
                    transaction.get('date') < target_date):

                    if transaction.get('action', '').lower() in ['buy', 'è²·å…¥']:
                        shares += transaction.get('shares', 0)
                    elif transaction.get('action', '').lower() in ['sell', 'è³£å‡º']:
                        shares -= transaction.get('shares', 0)

        return max(0, shares)  # ç¢ºä¿ä¸æœƒæ˜¯è² æ•¸

    def process_all_splits_for_ticker(self, position_data, ticker, transaction_history=None):
        """
        è™•ç†æŸæª”è‚¡ç¥¨çš„æ‰€æœ‰åˆ†å‰²äº‹ä»¶
        """
        if ticker not in self.events_data:
            print(f"âš ï¸ æ²’æœ‰æ‰¾åˆ° {ticker} çš„äº‹ä»¶è³‡æ–™")
            return []

        splits = self.events_data[ticker]['splits']
        if not splits:
            print(f"â„¹ï¸ {ticker} æ²’æœ‰è‚¡ç¥¨åˆ†å‰²äº‹ä»¶")
            return []

        # æŒ‰æ—¥æœŸæ’åºåˆ†å‰²äº‹ä»¶
        splits_sorted = sorted(splits, key=lambda x: x['date'])

        results = []
        for split in splits_sorted:
            result = self.apply_stock_split_with_timing(
                position_data,
                ticker,
                split['date'],
                split['ratio'],
                transaction_history
            )
            if result:
                results.append(result)

        return results

# ä½¿ç”¨ç¯„ä¾‹
if __name__ == "__main__":
    # å»ºç«‹è™•ç†å™¨
    processor = StockEventProcessor()

    # å‡è¨­çš„æŒå€‰è³‡æ–™
    position_data = {
        'AAPL': {
            'shares': 100,
            'avg_cost_foreign': 150.0,
            'total_cost_twd': 450000,
            'avg_exchange_rate': 30.0
        }
    }

    # å‡è¨­çš„äº¤æ˜“æ­·å²
    transaction_history = [
        {'date': datetime(2024, 1, 15), 'ticker': 'AAPL', 'action': 'buy', 'shares': 50},
        {'date': datetime(2024, 6, 15), 'ticker': 'AAPL', 'action': 'buy', 'shares': 50},
        # å‡è¨­è‚¡ç¥¨åˆ†å‰²ç™¼ç”Ÿåœ¨ 2024/3/15
    ]

    # æŠ“å–åˆ†å‰²äº‹ä»¶ä¸¦è™•ç†

import pandas as pd
import yfinance as yf
from tqdm import tqdm
import numpy as np
from datetime import datetime, timedelta
from collections import deque

# âœ… è‚¡ç¥¨åˆ†å‰²äº‹ä»¶è™•ç†é¡åˆ¥
class StockEventProcessor:
    def __init__(self):
        self.events_data = {}

    def fetch_stock_events(self, ticker, start_date, end_date):
        """
        æŠ“å–è‚¡ç¥¨åˆ†å‰²äº‹ä»¶è³‡æ–™ï¼Œä½¿ç”¨ yfinance.actions ä¸­çš„ Stock Splits æ¬„ä½
        """
        events = {
            'splits': []
        }
        try:
            stock = yf.Ticker(ticker)
            actions = stock.actions.reset_index()

            if actions.empty:
                return events

            actions["Date"] = actions["Date"].dt.tz_localize(None)
            actions = actions[
                (actions["Date"] >= start_date) &
                (actions["Date"] <= end_date)
            ].copy()

            # âœ… è™•ç†è‚¡ç¥¨åˆ†å‰²
            if "Stock Splits" in actions.columns:
                splits_df = actions[actions["Stock Splits"] > 0][["Date", "Stock Splits"]]
                if not splits_df.empty:
                    splits_df.columns = ["Date", "Split_Ratio"]

                    for _, row in splits_df.iterrows():
                        events["splits"].append({
                            "date": row["Date"],
                            "ratio": row["Split_Ratio"],
                            "type": "split"
                        })
        except Exception as e:
            print(f"âš ï¸ æŠ“å– {ticker} è‚¡ç¥¨åˆ†å‰²è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{e}")

        self.events_data[ticker] = events
        return events

    def apply_stock_split_with_timing(self, position_data, ticker, split_date, split_ratio, transaction_history=None):
        """
        ä¾æ“šæ™‚é–“è™•ç†è‚¡ç¥¨åˆ†å‰²äº‹ä»¶ - åªå°åˆ†å‰²æ—¥æœŸå‰å·²æŒæœ‰çš„è‚¡ç¥¨é€²è¡Œèª¿æ•´
        """
        if ticker not in position_data:
            print(f"âš ï¸ {ticker} ä¸åœ¨ç›®å‰æŒå€‰ä¸­ï¼Œç„¡éœ€è™•ç†åˆ†å‰²")
            return None

        pos = position_data[ticker]
        original_shares = pos['shares']
        original_avg_cost = pos['avg_cost_foreign']

        # å¦‚æœæœ‰äº¤æ˜“æ­·å²ï¼Œè¨ˆç®—åˆ†å‰²æ—¥å‰çš„æŒè‚¡
        if transaction_history is not None:
            shares_before_split = self._calculate_shares_before_date(
                transaction_history, ticker, split_date
            )

            if shares_before_split <= 0:
                print(f"â„¹ï¸ {ticker} åœ¨åˆ†å‰²æ—¥ {split_date.strftime('%Y-%m-%d')} å‰ç„¡æŒè‚¡ï¼Œç„¡éœ€èª¿æ•´")
                return None

            # è¨ˆç®—èª¿æ•´æ¯”ä¾‹
            adjustment_ratio = shares_before_split / original_shares if original_shares > 0 else 0

            # åªå°åˆ†å‰²æ—¥å‰çš„æŒè‚¡æ¯”ä¾‹é€²è¡Œèª¿æ•´
            additional_shares = shares_before_split * (split_ratio - 1)
            pos['shares'] = original_shares + additional_shares

            # é‡æ–°è¨ˆç®—å¹³å‡æˆæœ¬
            if pos['shares'] > 0:
                # åˆ†å‰²å‰æŒè‚¡çš„æˆæœ¬èª¿æ•´
                adjusted_cost_portion = shares_before_split * original_avg_cost / split_ratio
                # åˆ†å‰²å¾Œè²·å…¥çš„æˆæœ¬ä¿æŒä¸è®Š
                remaining_shares = original_shares - shares_before_split
                remaining_cost = remaining_shares * original_avg_cost

                total_cost = adjusted_cost_portion * split_ratio + remaining_cost
                pos['avg_cost_foreign'] = total_cost / pos['shares']

                # æ›´æ–°æœªå«äº¤æ˜“æˆæœ¬çš„ç¸½æˆæœ¬
                if 'pure_cost_foreign_total' in pos:
                    pos['pure_cost_foreign_total'] = pos['pure_cost_foreign_total'] + (shares_before_split * (split_ratio - 1) * (pos['pure_cost_foreign_total'] / original_shares))
        else:
            # æ²’æœ‰äº¤æ˜“æ­·å²æ™‚ï¼Œå‡è¨­æ‰€æœ‰æŒè‚¡éƒ½åœ¨åˆ†å‰²æ—¥å‰
            pos['shares'] *= split_ratio
            pos['avg_cost_foreign'] /= split_ratio
            if 'pure_cost_foreign_total' in pos:
                pos['pure_cost_foreign_total'] *= split_ratio

        # é‡æ–°è¨ˆç®—ç›¸é—œæˆæœ¬
        if pos['shares'] > 0 and pos["avg_cost_foreign"] > 0:
            pos["total_cost_twd"] = pos["avg_cost_foreign"] * pos["shares"] * pos["avg_exchange_rate"]

        print(f"âœ… {ticker} è‚¡ç¥¨åˆ†å‰²è™•ç†å®Œæˆ")
        print(f"   åˆ†å‰²æ—¥æœŸ: {split_date.strftime('%Y-%m-%d')}")
        print(f"   åˆ†å‰²æ¯”ä¾‹: {split_ratio}")
        print(f"   åŸå§‹è‚¡æ•¸: {original_shares}")
        print(f"   èª¿æ•´å¾Œè‚¡æ•¸: {pos['shares']}")
        print(f"   åŸå§‹å¹³å‡æˆæœ¬: ${original_avg_cost:.4f}")
        print(f"   èª¿æ•´å¾Œå¹³å‡æˆæœ¬: ${pos['avg_cost_foreign']:.4f}")

        return {
            'ticker': ticker,
            'date': split_date,
            'event': 'stock_split',
            'ratio': split_ratio,
            'original_shares': original_shares,
            'new_shares': pos['shares'],
            'original_avg_cost': original_avg_cost,
            'new_avg_cost': pos['avg_cost_foreign']
        }

    def _calculate_shares_before_date(self, transaction_history, ticker, target_date):
        """
        è¨ˆç®—ç‰¹å®šæ—¥æœŸå‰çš„æŒè‚¡æ•¸é‡
        """
        shares = 0

        if isinstance(transaction_history, pd.DataFrame):
            # DataFrame æ ¼å¼
            ticker_transactions = transaction_history[
                (transaction_history['è‚¡ç¥¨ä»£è™Ÿ'] == ticker) &
                (transaction_history['æ—¥æœŸ'] < target_date)
            ]

            for _, row in ticker_transactions.iterrows():
                shares += row['è³¼è²·è‚¡æ•¸']  # æ­£æ•¸ç‚ºè²·å…¥ï¼Œè² æ•¸ç‚ºè³£å‡º

        elif isinstance(transaction_history, list):
            # List æ ¼å¼
            for transaction in transaction_history:
                if (transaction.get('è‚¡ç¥¨ä»£è™Ÿ') == ticker and
                    transaction.get('æ—¥æœŸ') < target_date):
                    shares += transaction.get('è³¼è²·è‚¡æ•¸', 0)

        return max(0, shares)  # ç¢ºä¿ä¸æœƒæ˜¯è² æ•¸

    def process_all_splits_for_ticker(self, position_data, ticker, transaction_history=None):
        """
        è™•ç†æŸæª”è‚¡ç¥¨çš„æ‰€æœ‰åˆ†å‰²äº‹ä»¶
        """
        if ticker not in self.events_data:
            return []

        splits = self.events_data[ticker]['splits']
        if not splits:
            return []

        # æŒ‰æ—¥æœŸæ’åºåˆ†å‰²äº‹ä»¶
        splits_sorted = sorted(splits, key=lambda x: x['date'])

        results = []
        for split in splits_sorted:
            result = self.apply_stock_split_with_timing(
                position_data,
                ticker,
                split['date'],
                split['ratio'],
                transaction_history
            )
            if result:
                results.append(result)

        return results

# âœ… FIFO è™•ç†è‚¡ç¥¨åˆ†å‰²çš„å‡½æ•¸
def apply_fifo_stock_split(fifo_positions, ticker, split_date, split_ratio, transaction_history):
    """
    å° FIFO æŒå€‰é€²è¡Œè‚¡ç¥¨åˆ†å‰²èª¿æ•´
    """
    if ticker not in fifo_positions or not fifo_positions[ticker]:
        return

    # è¨ˆç®—åˆ†å‰²æ—¥å‰çš„æŒè‚¡
    shares_before_split = 0
    for transaction in transaction_history:
        if (transaction.get('è‚¡ç¥¨ä»£è™Ÿ') == ticker and
            transaction.get('æ—¥æœŸ') < split_date):
            shares_before_split += transaction.get('è³¼è²·è‚¡æ•¸', 0)

    if shares_before_split <= 0:
        return

    # å°æ¯å€‹æ‰¹æ¬¡æŒ‰æ™‚é–“é †åºèª¿æ•´
    adjusted_lots = []
    remaining_shares_to_adjust = shares_before_split

    for lot in fifo_positions[ticker]:
        if remaining_shares_to_adjust <= 0:
            adjusted_lots.append(lot)
            continue

        lot_shares = lot["shares"]
        shares_to_split = min(lot_shares, remaining_shares_to_adjust)

        if shares_to_split > 0:
            # åˆ†å‰²é€™éƒ¨åˆ†è‚¡ç¥¨
            split_portion = shares_to_split / lot_shares

            # èª¿æ•´é€™å€‹æ‰¹æ¬¡
            lot["shares"] = lot_shares + shares_to_split * (split_ratio - 1)
            lot["price"] = lot["price"] / split_ratio * (1 + split_portion * (split_ratio - 1)) / (1 + split_portion * (split_ratio - 1))
            lot["original_price"] = lot["original_price"] / split_ratio * (1 + split_portion * (split_ratio - 1)) / (1 + split_portion * (split_ratio - 1))

            remaining_shares_to_adjust -= shares_to_split

        adjusted_lots.append(lot)

    # æ›´æ–° FIFO æŒå€‰
    fifo_positions[ticker] = deque(adjusted_lots)

# è¼‰å…¥æ‚¨çš„æŠ•è³‡ç´€éŒ„è¡¨ï¼ˆExcel æ ¼å¼ï¼‰
#file_path = "C:\\Users\\frankyeh\\Documents\\funds\\V300-2-S.xlsx"

# 1. æ›è¼‰ Google Drive
#from google.colab import drive
#drive.mount('/content/drive')
#%cd /content/drive/MyDrive/Colab Notebooks/
#file_path = "V300-2-S.xlsx"



#colab update
file_path = "V300-2-S.xlsx"




df = pd.read_excel(file_path, sheet_name="Sheet1")
df["æ—¥æœŸ"] = pd.to_datetime(df["æ—¥æœŸ"])

# âœ… è®€å–åˆå§‹è³‡æ–™è¡¨ä¸­æ‰€æœ‰æ¬„ä½åŠè³‡è¨Šï¼Œå†åšå¾ŒçºŒè™•ç†
print("ğŸ“‹ åˆå§‹è³‡æ–™è¡¨æ¬„ä½ï¼š")
print(df.columns.tolist())
print(f"ç¸½ç­†æ•¸ï¼š{len(df)}")

# âœ… å»ºç«‹è²·è³£æ˜ç´°è¡¨ï¼ˆä¿ç•™æœ‰æ•ˆäº¤æ˜“ï¼‰
df_trades = df[df["è³¼è²·è‚¡æ•¸"].notna() & df["è³¼è²·è‚¡åƒ¹"].notna()].copy()

# âœ… ç¢ºä¿äº¤æ˜“æˆæœ¬æ¬„ä½å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨å‰‡è¨­ç‚º0
if "äº¤æ˜“æˆæœ¬" not in df_trades.columns:
    df_trades["äº¤æ˜“æˆæœ¬"] = 0.0
    print("âš ï¸ åŸå§‹è³‡æ–™ä¸­æœªæ‰¾åˆ° 'äº¤æ˜“æˆæœ¬' æ¬„ä½ï¼Œå·²è¨­å®šç‚º 0")
else:
    df_trades["äº¤æ˜“æˆæœ¬"] = df_trades["äº¤æ˜“æˆæœ¬"].fillna(0.0)

# âœ… ç¢ºä¿æ›åŒ¯åŒ¯ç‡æ¬„ä½å­˜åœ¨
if "æ›åŒ¯åŒ¯ç‡" not in df_trades.columns:
    print("âš ï¸ åŸå§‹è³‡æ–™ä¸­æœªæ‰¾åˆ° 'æ›åŒ¯åŒ¯ç‡' æ¬„ä½")
    df_trades["æ›åŒ¯åŒ¯ç‡"] = 1.0  # é è¨­ç‚º1ï¼ˆå°å¹£ï¼‰
else:
    df_trades["æ›åŒ¯åŒ¯ç‡"] = df_trades["æ›åŒ¯åŒ¯ç‡"].fillna(1.0)

# âœ… æ ¹æ“šè‚¡ç¥¨ä»£è™Ÿåˆ¤æ–·å¹£åˆ¥çš„å‡½æ•¸
def determine_currency(ticker):
    """æ ¹æ“šè‚¡ç¥¨ä»£è™Ÿåˆ¤æ–·äº¤æ˜“å¹£åˆ¥"""
    ticker = str(ticker).upper()

    # å°è‚¡åˆ¤æ–·
    if ticker.endswith('.TW') or ticker.endswith('.TWO'):
        return "TWD"
    elif ticker.isdigit() and len(ticker) == 4:  # å°è‚¡ä»£è™Ÿé€šå¸¸æ˜¯4ä½æ•¸å­—
        return "TWD"

    # æ¸¯è‚¡åˆ¤æ–·
    elif ticker.endswith('.HK'):
        return "HKD"

    # æ—¥è‚¡åˆ¤æ–·
    elif ticker.endswith('.T'):
        return "JPY"

    # è‹±è‚¡åˆ¤æ–·
    elif ticker.endswith('.L'):
        return "GBP"

    # å…¶ä»–æ­æ´²å¸‚å ´
    elif ticker.endswith('.DE') or ticker.endswith('.F'):
        return "EUR"

    # åŠ æ‹¿å¤§
    elif ticker.endswith('.TO'):
        return "CAD"

    # æ¾³æ´²
    elif ticker.endswith('.AX'):
        return "AUD"

    # é è¨­ç‚ºç¾è‚¡ (åŒ…å« ETFã€ç¾åœ‹å…¬å¸ç­‰)
    else:
        return "USD"

# âœ… è‡ªå‹•åˆ¤æ–·æ¯æª”è‚¡ç¥¨çš„å¹£åˆ¥
df_trades["å¹£åˆ¥"] = df_trades["è‚¡ç¥¨ä»£è™Ÿ"].apply(determine_currency)

# é¡¯ç¤ºå¹£åˆ¥åˆ¤æ–·çµæœ
print("ğŸ“‹ å„è‚¡ç¥¨ä»£è™Ÿå°æ‡‰å¹£åˆ¥ï¼š")
currency_mapping = df_trades[["è‚¡ç¥¨ä»£è™Ÿ", "å¹£åˆ¥"]].drop_duplicates().sort_values("è‚¡ç¥¨ä»£è™Ÿ")
for _, row in currency_mapping.iterrows():
    print(f"  {row['è‚¡ç¥¨ä»£è™Ÿ']} â†’ {row['å¹£åˆ¥']}")

# æª¢æŸ¥è³‡æ–™è¡¨å…§çš„æ—¥æœŸç¯„åœ
min_date = df_trades["æ—¥æœŸ"].min()
max_date = df_trades["æ—¥æœŸ"].max()
print(f"\nğŸ“… è³‡æ–™æ—¥æœŸç¯„åœï¼š{min_date.strftime('%Y-%m-%d')} è‡³ {max_date.strftime('%Y-%m-%d')}")

# å–å¾—æ‰€æœ‰éå°å¹£çš„å¹£åˆ¥
currencies = df_trades[df_trades["å¹£åˆ¥"] != "TWD"]["å¹£åˆ¥"].unique()
print(f"ğŸ’± éœ€è¦æŠ“å–çš„å¹£åˆ¥ï¼š{list(currencies)}")

# âœ… ä¸‹è¼‰æ­·å²åŒ¯ç‡è³‡æ–™
def download_fx_history(currency, start_date, end_date):
    """ä¸‹è¼‰æŒ‡å®šå¹£åˆ¥å°å°å¹£çš„æ­·å²åŒ¯ç‡"""
    try:
        fx_symbol = f"{currency}TWD=X"
        print(f"æ­£åœ¨ä¸‹è¼‰ {fx_symbol} æ­·å²åŒ¯ç‡...")

        # æ“´å¤§æ—¥æœŸç¯„åœä»¥ç¢ºä¿æ¶µè“‹æ‰€æœ‰äº¤æ˜“æ—¥
        start_extended = start_date - timedelta(days=10)
        end_extended = end_date + timedelta(days=10)

        fx_data = yf.download(fx_symbol, start=start_extended, end=end_extended,
                             auto_adjust=True, progress=False)

        if fx_data.empty:
            print(f"âš ï¸ ç„¡æ³•å–å¾— {fx_symbol} åŒ¯ç‡è³‡æ–™")
            return pd.DataFrame()

        fx_df = fx_data["Close"].reset_index()
        fx_df.columns = ["æ—¥æœŸ", "åŒ¯ç‡"]
        fx_df["æ—¥æœŸ"] = pd.to_datetime(fx_df["æ—¥æœŸ"])
        fx_df["å¹£åˆ¥"] = currency

        return fx_df

    except Exception as e:
        print(f"âš ï¸ ä¸‹è¼‰ {currency} åŒ¯ç‡æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{e}")
        return pd.DataFrame()

# âœ… ä¸‹è¼‰è‚¡ç¥¨æ­·å²åƒ¹æ ¼
def download_stock_history(ticker, start_date, end_date):
    """ä¸‹è¼‰è‚¡ç¥¨æ­·å²åƒ¹æ ¼"""
    try:
        print(f"æ­£åœ¨ä¸‹è¼‰ {ticker} æ­·å²åƒ¹æ ¼...")

        # æ“´å¤§æ—¥æœŸç¯„åœ
        start_extended = start_date - timedelta(days=10)
        end_extended = end_date + timedelta(days=10)

        stock_data = yf.download(ticker, start=start_extended, end=end_extended,
                                auto_adjust=True, progress=False)

        if stock_data.empty:
            print(f"âš ï¸ ç„¡æ³•å–å¾— {ticker} è‚¡åƒ¹è³‡æ–™")
            return pd.DataFrame()

        stock_df = stock_data["Close"].reset_index()
        stock_df.columns = ["æ—¥æœŸ", "æ”¶ç›¤åƒ¹"]
        stock_df["æ—¥æœŸ"] = pd.to_datetime(stock_df["æ—¥æœŸ"])
        stock_df["è‚¡ç¥¨ä»£è™Ÿ"] = ticker

        return stock_df

    except Exception as e:
        print(f"âš ï¸ ä¸‹è¼‰ {ticker} è‚¡åƒ¹æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{e}")
        return pd.DataFrame()

# âœ… å»ºç«‹åŒ¯ç‡æŸ¥è©¢å‡½æ•¸
def get_fx_rate(date, currency, fx_data_dict):
    """æ ¹æ“šæ—¥æœŸå’Œå¹£åˆ¥æŸ¥è©¢åŒ¯ç‡"""
    if currency == "TWD":
        return 1.0

    if currency not in fx_data_dict or fx_data_dict[currency].empty:
        return np.nan

    fx_df = fx_data_dict[currency]

    # æ‰¾æœ€æ¥è¿‘çš„äº¤æ˜“æ—¥åŒ¯ç‡
    closest_date = fx_df.loc[(fx_df["æ—¥æœŸ"] <= date), "æ—¥æœŸ"].max()

    if pd.isna(closest_date):
        # å¦‚æœæ‰¾ä¸åˆ°æ›´æ—©çš„æ—¥æœŸï¼Œä½¿ç”¨æœ€è¿‘çš„æ—¥æœŸ
        closest_date = fx_df["æ—¥æœŸ"].min()

    rate = fx_df.loc[fx_df["æ—¥æœŸ"] == closest_date, "åŒ¯ç‡"]
    return rate.iloc[0] if not rate.empty else np.nan

# âœ… ä¸‹è¼‰æ‰€æœ‰éœ€è¦çš„åŒ¯ç‡è³‡æ–™
fx_data_dict = {}
for currency in currencies:
    fx_df = download_fx_history(currency, min_date, max_date)
    if not fx_df.empty:
        fx_data_dict[currency] = fx_df

# âœ… ä¸‹è¼‰æ‰€æœ‰è‚¡ç¥¨çš„æ­·å²åƒ¹æ ¼
tickers = df_trades["è‚¡ç¥¨ä»£è™Ÿ"].unique()
stock_data_dict = {}
for ticker in tickers:
    stock_df = download_stock_history(ticker, min_date, max_date)
    if not stock_df.empty:
        stock_data_dict[ticker] = stock_df

# âœ… æ›´æ–°è²·è³£æ˜ç´°ä¸­çš„è³¼è²·ç•¶æ™‚åŒ¯ç‡ï¼ˆé‡å°éå°å¹£å•†å“ï¼‰
print("ğŸ“Š æ­£åœ¨æ›´æ–°è²·è³£æ˜ç´°ä¸­çš„æ­·å²åŒ¯ç‡...")
df_trades["è³¼è²·ç•¶æ™‚åŒ¯ç‡_æ­·å²"] = df_trades.apply(
    lambda row: get_fx_rate(row["æ—¥æœŸ"], row["å¹£åˆ¥"], fx_data_dict), axis=1
)

# å¦‚æœæ­·å²åŒ¯ç‡å­˜åœ¨ï¼Œå‰‡ä½¿ç”¨æ­·å²åŒ¯ç‡ï¼Œå¦å‰‡ä¿ç•™åŸå§‹åŒ¯ç‡
df_trades["è³¼è²·ç•¶æ™‚åŒ¯ç‡"] = df_trades["è³¼è²·ç•¶æ™‚åŒ¯ç‡_æ­·å²"].fillna(df_trades["æ›åŒ¯åŒ¯ç‡"])

# âœ… å»ºç«‹å‡½æ•¸å–å¾—å„å¹£åˆ¥çš„æœ€æ–°åŒ¯ç‡
def get_latest_fx_rate(currency, fx_data_dict):
    """å¾å·²ä¸‹è¼‰çš„æ­·å²åŒ¯ç‡è³‡æ–™ä¸­å–å¾—æœ€æ–°åŒ¯ç‡"""
    if currency == "TWD":
        return 1.0

    if currency not in fx_data_dict or fx_data_dict[currency].empty:
        print(f"âš ï¸ {currency} åŒ¯ç‡è³‡æ–™ä¸å­˜åœ¨ï¼Œå˜—è©¦é‡æ–°ä¸‹è¼‰...")
        # å¦‚æœæ²’æœ‰è³‡æ–™ï¼Œå˜—è©¦ä¸‹è¼‰æœ€è¿‘5å¤©çš„åŒ¯ç‡
        try:
            fx_symbol = f"{currency}TWD=X"
            fx_data = yf.download(fx_symbol, period="5d", interval="1d", auto_adjust=True, progress=False)
            if not fx_data.empty:
                return float(fx_data["Close"].dropna().iloc[-1])
        except:
            pass
        return np.nan

    fx_df = fx_data_dict[currency]
    latest_rate = fx_df.sort_values("æ—¥æœŸ", ascending=False).iloc[0]["åŒ¯ç‡"]
    return float(latest_rate)

# âœ… å¹³å‡æˆæœ¬æ³•è™•ç†ï¼ˆå«äº¤æ˜“æˆæœ¬ï¼‰ - åˆå§‹åŒ–æŒå€‰å’Œå·²å¯¦ç¾æç›Š
position_data = {}
realized_pnl_data = {}
transaction_cost_data = {}  # è¨˜éŒ„äº¤æ˜“æˆæœ¬

# âœ… è™•ç†æ¯ä¸€ç­†äº¤æ˜“ï¼ˆä½¿ç”¨å¹³å‡æˆæœ¬æ³•ï¼Œå«äº¤æ˜“æˆæœ¬ï¼‰
print("ğŸ“ˆ æ­£åœ¨è™•ç†äº¤æ˜“è¨˜éŒ„ï¼ˆä½¿ç”¨å¹³å‡æˆæœ¬æ³•ï¼Œå«äº¤æ˜“æˆæœ¬ï¼‰...")
for _, row in df_trades.sort_values("æ—¥æœŸ").iterrows():
    ticker = row["è‚¡ç¥¨ä»£è™Ÿ"]
    shares = row["è³¼è²·è‚¡æ•¸"]
    price = row["è³¼è²·è‚¡åƒ¹"]
    currency = row["å¹£åˆ¥"]
    exchange_rate = row["æ›åŒ¯åŒ¯ç‡"]  # ä½¿ç”¨æ›åŒ¯åŒ¯ç‡ä¾†è¨ˆç®—äº¤æ˜“æˆæœ¬
    transaction_cost = row["äº¤æ˜“æˆæœ¬"]  # äº¤æ˜“æˆæœ¬

    if ticker not in position_data:
        position_data[ticker] = {
            "shares": 0,
            "avg_cost_foreign": 0.0,  # å¹³å‡æˆæœ¬(åŸå¹£)ï¼Œå«äº¤æ˜“æˆæœ¬
            "pure_cost_foreign_total": 0.0,  # æœªå«äº¤æ˜“æˆæœ¬ç¸½æˆæœ¬ï¼ˆå¤–å¹£ï¼‰
            "avg_exchange_rate": 0.0,  # å¹³å‡åŒ¯ç‡
            "total_cost_twd": 0.0,  # ç¸½æˆæœ¬(å°å¹£)ï¼Œå«äº¤æ˜“æˆæœ¬
            "currency": currency
        }
        realized_pnl_data[ticker] = {
            "total_realized_pnl": 0.0,
            "currency": currency
        }
        transaction_cost_data[ticker] = {
            "total_cost": 0.0,
            "currency": currency
        }

    pos = position_data[ticker]
    realized = realized_pnl_data[ticker]
    tx_cost = transaction_cost_data[ticker]

    # è¨ˆç®—äº¤æ˜“æˆæœ¬(å°å¹£)
    transaction_cost_twd = transaction_cost * exchange_rate
    tx_cost["total_cost"] += transaction_cost_twd

    if shares > 0:  # è²·é€² - å¹³å‡æˆæœ¬æ³•è¨ˆç®—ï¼ˆå«äº¤æ˜“æˆæœ¬ï¼‰
        # è¨ˆç®—å«äº¤æ˜“æˆæœ¬çš„å¯¦éš›æˆæœ¬
        # å¯¦éš›æ¯è‚¡æˆæœ¬ = (è‚¡åƒ¹ * è‚¡æ•¸ + äº¤æ˜“æˆæœ¬) / è‚¡æ•¸
        actual_cost_per_share = (price * shares + transaction_cost) / shares

        # è²·é€²æ™‚é¡å¤–ç´¯åŠ æœªå«äº¤æ˜“æˆæœ¬çš„ç¸½æˆæœ¬
        pos["pure_cost_foreign_total"] += price * shares

        # è¨ˆç®—æ–°çš„ç¸½æŒè‚¡å’Œç¸½æˆæœ¬
        new_total_shares = pos["shares"] + shares
        new_total_cost_foreign = pos["avg_cost_foreign"] * pos["shares"] + actual_cost_per_share * shares
        new_total_cost_twd = pos["total_cost_twd"] + (actual_cost_per_share * shares * exchange_rate)

        # æ›´æ–°å¹³å‡æˆæœ¬å’Œå¹³å‡åŒ¯ç‡
        if new_total_shares > 0:
            pos["avg_cost_foreign"] = new_total_cost_foreign / new_total_shares
            pos["avg_exchange_rate"] = new_total_cost_twd / new_total_cost_foreign
            pos["shares"] = new_total_shares
            pos["total_cost_twd"] = new_total_cost_twd

    else:  # è³£å‡º - è¨ˆç®—å·²å¯¦ç¾æç›Šï¼ˆæ‰£é™¤äº¤æ˜“æˆæœ¬ï¼‰
        sell_shares = abs(shares)  # è³£å‡ºè‚¡æ•¸ç‚ºæ­£æ•¸

        if pos["shares"] >= sell_shares:
            # è¨ˆç®—è³£å‡ºæ”¶å…¥ï¼ˆæ‰£é™¤äº¤æ˜“æˆæœ¬ï¼‰
            gross_proceeds = price * sell_shares  # ç¸½æ”¶å…¥
            net_proceeds = gross_proceeds - transaction_cost  # æ‰£é™¤äº¤æ˜“æˆæœ¬å¾Œçš„æ·¨æ”¶å…¥

            # è¨ˆç®—æˆæœ¬
            cost_basis = pos["avg_cost_foreign"] * sell_shares  # æˆæœ¬åŸºç¤

            # è¨ˆç®—å·²å¯¦ç¾æç›Š = (æ·¨æ”¶å…¥ - æˆæœ¬åŸºç¤) * å¹³å‡åŒ¯ç‡
            realized_pnl_foreign = net_proceeds - cost_basis
            realized_pnl_twd = realized_pnl_foreign * pos["avg_exchange_rate"]

            # ç´¯åŠ å·²å¯¦ç¾æç›Š
            realized["total_realized_pnl"] += realized_pnl_twd

            # æ›´æ–°æœªå«äº¤æ˜“æˆæœ¬çš„ç¸½é¡ï¼ˆéœ€å¹³å‡æ‹†åˆ†ï¼‰
            if pos["shares"] > 0:
                cost_pure_foreign = (pos["pure_cost_foreign_total"] / pos["shares"]) * sell_shares
                pos["pure_cost_foreign_total"] -= cost_pure_foreign
            else:
                pos["pure_cost_foreign_total"] = 0.0

            # æ›´æ–°æŒå€‰ï¼ˆå¹³å‡æˆæœ¬ä¸è®Šï¼Œåªæ¸›å°‘è‚¡æ•¸å’Œç¸½æˆæœ¬ï¼‰
            pos["shares"] -= sell_shares
            if pos["shares"] > 0:
                pos["total_cost_twd"] = pos["avg_cost_foreign"] * pos["shares"] * pos["avg_exchange_rate"]
            else:
                pos["total_cost_twd"] = 0.0
        else:
            print(f"âš ï¸ {ticker} è³£å‡ºè‚¡æ•¸ {sell_shares} è¶…éæŒæœ‰è‚¡æ•¸ {pos['shares']}")

# âœ… ğŸ¯ åœ¨æ­¤æ’å…¥è‚¡ç¥¨åˆ†å‰²äº‹ä»¶è™•ç†
print("\n" + "="*80)
print("ğŸ”„ æ­£åœ¨è™•ç†è‚¡ç¥¨åˆ†å‰²äº‹ä»¶...")

event_processor = StockEventProcessor()
all_split_results = []

# è½‰æ›äº¤æ˜“æ­·å²æ ¼å¼ä¾›äº‹ä»¶è™•ç†å™¨ä½¿ç”¨
transaction_history = []
for _, row in df_trades.iterrows():
    transaction_history.append({
        'è‚¡ç¥¨ä»£è™Ÿ': row['è‚¡ç¥¨ä»£è™Ÿ'],
        'æ—¥æœŸ': row['æ—¥æœŸ'],
        'è³¼è²·è‚¡æ•¸': row['è³¼è²·è‚¡æ•¸']
    })

# è™•ç†æ¯æª”è‚¡ç¥¨çš„åˆ†å‰²äº‹ä»¶
for ticker in position_data.keys():
    print(f"\nğŸ“Š æª¢æŸ¥ {ticker} çš„è‚¡ç¥¨åˆ†å‰²äº‹ä»¶...")

    # æŠ“å–è‚¡ç¥¨åˆ†å‰²äº‹ä»¶
    events = event_processor.fetch_stock_events(ticker, min_date, max_date)

    if events["splits"]:
        print(f"âœ… ç™¼ç¾ {len(events['splits'])} å€‹åˆ†å‰²äº‹ä»¶")

        # è™•ç†æ‰€æœ‰åˆ†å‰²äº‹ä»¶
        split_results = event_processor.process_all_splits_for_ticker(
            position_data, ticker, transaction_history
        )

        all_split_results.extend(split_results)
    else:
        print(f"â„¹ï¸ {ticker} ç„¡è‚¡ç¥¨åˆ†å‰²äº‹ä»¶")

# é¡¯ç¤ºåˆ†å‰²è™•ç†çµæœæ‘˜è¦
if all_split_results:
    print(f"\nğŸ“‹ è‚¡ç¥¨åˆ†å‰²è™•ç†æ‘˜è¦ï¼š")
    for result in all_split_results:
        print(f"  {result['ticker']}: {result['date'].strftime('%Y-%m-%d')} "
              f"åˆ†å‰²æ¯”ä¾‹ {result['ratio']}, è‚¡æ•¸ {result['original_shares']} â†’ {result['new_shares']}")
else:
    print("â„¹ï¸ æœ¬æœŸé–“å…§ç„¡è‚¡ç¥¨åˆ†å‰²äº‹ä»¶éœ€è¦è™•ç†")



# âœ… è¨ˆç®—åº«å­˜æ˜ç´°è¡¨ï¼ˆå¹³å‡æˆæœ¬æ³•ï¼Œå«äº¤æ˜“æˆæœ¬ï¼‰
position_list = []
for ticker, pos in position_data.items():
    if pos["shares"] > 0:  # åªé¡¯ç¤ºæœ‰æŒè‚¡çš„é …ç›®
        position_list.append({
            "è‚¡ç¥¨ä»£è™Ÿ": ticker,
            "å¹£åˆ¥": pos["currency"],
            "æŒæœ‰è‚¡æ•¸": pos["shares"],
            "å¹³å‡æˆæœ¬(åŸå¹£)(æœªå«äº¤æ˜“æˆæœ¬)": pos["pure_cost_foreign_total"] / pos["shares"],
            "å¹³å‡æˆæœ¬(åŸå¹£)": pos["avg_cost_foreign"],  # å·²å«äº¤æ˜“æˆæœ¬
            "å¹³å‡åŒ¯ç‡æˆæœ¬": pos["avg_exchange_rate"],
            "ç¸½æˆæœ¬(åŸå¹£)": pos["avg_cost_foreign"] * pos["shares"],
            "ç¸½æˆæœ¬(å°å¹£)": pos["total_cost_twd"]  # å·²å«äº¤æ˜“æˆæœ¬
        })

position_df = pd.DataFrame(position_list)

if not position_df.empty:
    # âœ… æŠ“å–æœ€æ–°åƒ¹æ ¼
    current_tickers = position_df["è‚¡ç¥¨ä»£è™Ÿ"].tolist()
    latest_prices = {}

    for ticker in tqdm(current_tickers, desc="ä¸‹è¼‰æœ€æ–°åƒ¹æ ¼"):
        try:
            data = yf.download(ticker, period="5d", interval="1d", auto_adjust=True, progress=False)
            if not data.empty:
                latest_prices[ticker] = float(data["Close"].dropna().iloc[-1])
        except Exception as e:
            print(f"âš ï¸ ç„¡æ³•ä¸‹è¼‰ {ticker}ï¼š{e}")

    # âœ… å–å¾—å„æ¨™çš„å°æ‡‰çš„æœ€æ–°åŒ¯ç‡
    print("ğŸ“Š æ­£åœ¨å–å¾—å„æ¨™çš„çš„æœ€æ–°åŒ¯ç‡...")
    position_df["æœ€æ–°åŒ¯ç‡"] = position_df["å¹£åˆ¥"].apply(lambda x: get_latest_fx_rate(x, fx_data_dict))

    # é¡¯ç¤ºåŒ¯ç‡è³‡è¨Š
    print("ğŸ’± å„æ¨™çš„æœ€æ–°åŒ¯ç‡ï¼š")
    for _, row in position_df.iterrows():
        print(f"  {row['è‚¡ç¥¨ä»£è™Ÿ']} ({row['å¹£åˆ¥']}): {row['æœ€æ–°åŒ¯ç‡']:.4f}")

    # âœ… è¨ˆç®—å¸‚å€¼å’Œæç›Šï¼ˆå¹³å‡æˆæœ¬æ³•ï¼Œå«äº¤æ˜“æˆæœ¬è€ƒé‡ï¼‰
    position_df["ç¾åƒ¹(åŸå¹£)"] = position_df["è‚¡ç¥¨ä»£è™Ÿ"].map(latest_prices)
    position_df["ç¾åƒ¹(å°å¹£)"] = position_df["ç¾åƒ¹(åŸå¹£)"] * position_df["æœ€æ–°åŒ¯ç‡"]
    position_df["å¸‚å€¼(åŸå¹£)"] = position_df["ç¾åƒ¹(åŸå¹£)"] * position_df["æŒæœ‰è‚¡æ•¸"]
    position_df["å¸‚å€¼(å°å¹£)"] = position_df["ç¾åƒ¹(å°å¹£)"] * position_df["æŒæœ‰è‚¡æ•¸"]

    # è¨ˆç®—å„é …æç›Šï¼ˆæ³¨æ„ï¼šè³£å‡ºæ™‚é‚„éœ€æ‰£é™¤äº¤æ˜“æˆæœ¬ï¼Œæ‰€ä»¥æœªå¯¦ç¾æç›Šéœ€è¦è€ƒæ…®æ½›åœ¨äº¤æ˜“æˆæœ¬ï¼‰
    # æœªå¯¦ç¾æŠ•è³‡æç›Š(åŸå¹£) = (ç¾åƒ¹ - å¹³å‡æˆæœ¬) * æŒæœ‰è‚¡æ•¸
    position_df["æœªå¯¦ç¾æŠ•è³‡æç›Š(åŸå¹£)"] = (position_df["ç¾åƒ¹(åŸå¹£)"] - position_df["å¹³å‡æˆæœ¬(åŸå¹£)"]) * position_df["æŒæœ‰è‚¡æ•¸"]

    # æœªå¯¦ç¾æŠ•è³‡æç›Š(å°å¹£) = æœªå¯¦ç¾æŠ•è³‡æç›Š(åŸå¹£) * å¹³å‡åŒ¯ç‡æˆæœ¬->æ”¹æˆæœ€æ–°åŒ¯ç‡
    position_df["æœªå¯¦ç¾æŠ•è³‡æç›Š(å°å¹£)"] = position_df["æœªå¯¦ç¾æŠ•è³‡æç›Š(åŸå¹£)"] * position_df["æœ€æ–°åŒ¯ç‡"]

    # æœªå¯¦ç¾ç¸½æç›Š(å°å¹£) = å¸‚å€¼(å°å¹£) - ç¸½æˆæœ¬(å°å¹£)
    position_df["æœªå¯¦ç¾ç¸½æç›Š(å°å¹£)"] = position_df["å¸‚å€¼(å°å¹£)"] - position_df["ç¸½æˆæœ¬(å°å¹£)"]

    # æœªå¯¦ç¾åŒ¯ç‡æç›Š(å°å¹£) = æœªå¯¦ç¾ç¸½æç›Š(å°å¹£) - æœªå¯¦ç¾æŠ•è³‡æç›Š(å°å¹£)
    position_df["æœªå¯¦ç¾æŠ•è³‡åŒ¯ç‡æç›Š(å°å¹£)"] = position_df["æœªå¯¦ç¾ç¸½æç›Š(å°å¹£)"] - position_df["æœªå¯¦ç¾æŠ•è³‡æç›Š(å°å¹£)"]

# âœ… å·²å¯¦ç¾æç›Šè¡¨ï¼ˆå¹³å‡æˆæœ¬æ³•ï¼Œå«äº¤æ˜“æˆæœ¬ï¼‰
realized_list = []
for ticker, data in realized_pnl_data.items():
    if data["total_realized_pnl"] != 0:
        realized_list.append({
            "è‚¡ç¥¨ä»£è™Ÿ": ticker,
            "å¹£åˆ¥": data["currency"],
            "å·²å¯¦ç¾ç¸½æç›Š(å°å¹£)": data["total_realized_pnl"]
        })

realized_df = pd.DataFrame(realized_list)

# âœ… äº¤æ˜“æˆæœ¬çµ±è¨ˆè¡¨
cost_list = []
for ticker, data in transaction_cost_data.items():
    if data["total_cost"] != 0:
        cost_list.append({
            "è‚¡ç¥¨ä»£è™Ÿ": ticker,
            "å¹£åˆ¥": data["currency"],
            "ç´¯è¨ˆäº¤æ˜“æˆæœ¬(å°å¹£)": data["total_cost"]
        })

cost_df = pd.DataFrame(cost_list)

# âœ… ğŸ§¾ é¡¯ç¤ºè²·è³£æ˜ç´°ï¼ˆå«æ­·å²åŒ¯ç‡æ›´æ–°ï¼Œæ–°å¢æˆäº¤é‡‘é¡èˆ‡äº¤æ˜“æˆæœ¬æ¬„ä½ï¼‰
print("\n" + "="*80)
print("ğŸ§¾ è²·è³£æ˜ç´°ï¼ˆå«æ­·å²åŒ¯ç‡æ›´æ–°åŠäº¤æ˜“æˆæœ¬ï¼‰")

# å…ˆæª¢æŸ¥df_tradesä¸­å¯¦éš›å­˜åœ¨çš„æ¬„ä½
print("ğŸ“‹ df_trades ä¸­å¯ç”¨çš„æ¬„ä½ï¼š", df_trades.columns.tolist())

# å»ºç«‹é¡¯ç¤ºç”¨çš„è²·è³£æ˜ç´°è¡¨ï¼ˆåªé¸æ“‡å­˜åœ¨çš„æ¬„ä½ï¼‰
base_columns = ["æ—¥æœŸ", "è‚¡ç¥¨ä»£è™Ÿ", "å¹£åˆ¥", "è³¼è²·è‚¡æ•¸", "è³¼è²·è‚¡åƒ¹", "æ›åŒ¯åŒ¯ç‡", "è³¼è²·ç•¶æ™‚åŒ¯ç‡", "äº¤æ˜“æˆæœ¬"]
available_columns = [col for col in base_columns if col in df_trades.columns]

# æª¢æŸ¥æŠ•è³‡é‡‘é¡æ¬„ä½æ˜¯å¦å­˜åœ¨
if "æŠ•è³‡é‡‘é¡" in df_trades.columns:
    available_columns.append("æŠ•è³‡é‡‘é¡")
else:
    print("âš ï¸ åŸå§‹è³‡æ–™ä¸­æœªæ‰¾åˆ° 'æŠ•è³‡é‡‘é¡' æ¬„ä½")

display_df = df_trades[available_columns].copy()

# æ–°å¢ï¼šæˆäº¤é‡‘é¡ï¼ˆå–çµ•å°å€¼ï¼‰
if "äº¤æ˜“é‡‘é¡" in df_trades.columns:
    display_df["æˆäº¤é‡‘é¡"] = df_trades["äº¤æ˜“é‡‘é¡"].abs()
else:
    print("âš ï¸ åŸå§‹è³‡æ–™ä¸­æœªæ‰¾åˆ° 'äº¤æ˜“é‡‘é¡' æ¬„ä½")
    display_df["æˆäº¤é‡‘é¡"] = 0.0

# æ–°å¢ï¼šäº¤æ˜“æˆæœ¬(å°å¹£)
display_df["äº¤æ˜“æˆæœ¬(å°å¹£)"] = df_trades["äº¤æ˜“æˆæœ¬"] * df_trades["æ›åŒ¯åŒ¯ç‡"]

# æ¬„ä½åç¨±èª¿æ•´
display_df = display_df.rename(columns={
    "æ›åŒ¯åŒ¯ç‡": "åŸå§‹åŒ¯ç‡",
    "è³¼è²·ç•¶æ™‚åŒ¯ç‡": "æ­·å²åŒ¯ç‡"
})

# é¡¯ç¤ºçµæœ
print(display_df.to_string(index=False))

# âœ… åŒ¯ç‡æ›´æ–°çµ±è¨ˆ
fx_updated_count = (~df_trades["è³¼è²·ç•¶æ™‚åŒ¯ç‡_æ­·å²"].isna()).sum()
total_records = len(df_trades)
twd_records = (df_trades["å¹£åˆ¥"] == "TWD").sum()
foreign_records = total_records - twd_records

print(f"\nğŸ“Š åŒ¯ç‡æ›´æ–°çµ±è¨ˆï¼š")
print(f"ç¸½äº¤æ˜“ç­†æ•¸ï¼š{total_records}")
print(f"å°å¹£å•†å“ï¼š{twd_records} ç­†")
print(f"å¤–å¹£å•†å“ï¼š{foreign_records} ç­†")
print(f"æˆåŠŸæ›´æ–°æ­·å²åŒ¯ç‡ï¼š{fx_updated_count} ç­†")
if foreign_records > 0:
    print(f"å¤–å¹£å•†å“åŒ¯ç‡æ›´æ–°æ¯”ä¾‹ï¼š{fx_updated_count/foreign_records*100:.1f}%")

# âœ… é¡¯ç¤ºå·²ä¸‹è¼‰çš„åŒ¯ç‡è³‡æ–™æ‘˜è¦
print(f"\nğŸ’± å·²ä¸‹è¼‰åŒ¯ç‡è³‡æ–™æ‘˜è¦ï¼š")
for currency, fx_df in fx_data_dict.items():
    if not fx_df.empty:
        latest_date = fx_df["æ—¥æœŸ"].max().strftime('%Y-%m-%d')
        latest_rate = fx_df.sort_values("æ—¥æœŸ", ascending=False).iloc[0]["åŒ¯ç‡"]
        print(f"  {currency}TWD: æœ€æ–°æ—¥æœŸ {latest_date}, æœ€æ–°åŒ¯ç‡ {latest_rate:.4f}")

# âœ… é¡¯ç¤ºåº«å­˜æ˜ç´°è¡¨
print("\n" + "="*80)
print("ğŸ“Š åº«å­˜æ˜ç´°è¡¨ï¼ˆå¹³å‡æˆæœ¬æ³•ï¼Œå«äº¤æ˜“æˆæœ¬ï¼‰")
if not position_df.empty:
    print(position_df.to_string(index=False))
else:
    print("ç›®å‰ç„¡æŒè‚¡")

# âœ… å·²å¯¦ç¾æç›Šè¡¨ï¼ˆå¹³å‡æˆæœ¬æ³•ï¼‰
realized_list = []
for ticker, data in realized_pnl_data.items():
    if data["total_realized_pnl"] != 0:
        realized_list.append({
            "è‚¡ç¥¨ä»£è™Ÿ": ticker,
            "å¹£åˆ¥": data["currency"],
            "å·²å¯¦ç¾ç¸½æç›Š(å°å¹£)": data["total_realized_pnl"]
        })

realized_df = pd.DataFrame(realized_list)

# âœ… é¡¯ç¤ºäº¤æ˜“æˆæœ¬çµ±è¨ˆè¡¨
print("\n" + "="*80)
print("ğŸ’³ äº¤æ˜“æˆæœ¬çµ±è¨ˆè¡¨")
if not cost_df.empty:
    print(cost_df.to_string(index=False))
    total_transaction_cost = cost_df["ç´¯è¨ˆäº¤æ˜“æˆæœ¬(å°å¹£)"].sum()
    print(f"\nç¸½äº¤æ˜“æˆæœ¬ï¼šNT$ {total_transaction_cost:,.0f}")
else:
    print("ç„¡äº¤æ˜“æˆæœ¬è¨˜éŒ„")

# âœ… æ•´åˆ FIFO æ³•é€²ä½ çš„ä¸»ç¨‹å¼ï¼šèˆ‡å¹³å‡æˆæœ¬æ³•æ¬„ä½ä¸€è‡´
from collections import deque
import numpy as np
import yfinance as yf
import pandas as pd

def get_latest_fx_rate(currency, fx_data_dict):
    if currency == "TWD":
        return 1.0
    if currency not in fx_data_dict or fx_data_dict[currency].empty:
        return np.nan

    fx_df = fx_data_dict[currency]
    # ä¿éšªåšæ³•ï¼šæŒ‰æ—¥æœŸæ’åºã€å»é™¤ NaNã€å–æœ€æ–°çš„åŒ¯ç‡
    fx_df = fx_df.dropna(subset=["åŒ¯ç‡"]).sort_values("æ—¥æœŸ", ascending=False)
    if fx_df.empty:
        return np.nan
    return float(fx_df.iloc[0]["åŒ¯ç‡"])

def build_fifo_inventory_with_cost_fixed(df_trades, fx_data_dict, latest_prices=None):
    """
    ä¿®æ­£å¾Œçš„FIFOæ³•åº«å­˜æ˜ç´°è¨ˆç®—ï¼Œç¢ºä¿èˆ‡å¹³å‡æˆæœ¬æ³•çš„åŒ¯ç‡è¨ˆç®—é‚è¼¯ä¸€è‡´
    """
    fifo_positions = {}
    fifo_realized_pnl_data = {}
    fifo_position_list = []

    for _, row in df_trades.sort_values("æ—¥æœŸ").iterrows():
        ticker = row["è‚¡ç¥¨ä»£è™Ÿ"]
        shares = row["è³¼è²·è‚¡æ•¸"]
        price = row["è³¼è²·è‚¡åƒ¹"]
        fx = row["æ›åŒ¯åŒ¯ç‡"]  # ğŸ”§ ä¿®æ­£ï¼šä½¿ç”¨è³¼è²·ç•¶æ™‚åŒ¯ç‡ï¼ˆåŒ…å«æ­·å²åŒ¯ç‡æ›´æ–°)->æ”¹æˆæ›åŒ¯åŒ¯ç‡
        currency = row["å¹£åˆ¥"]
        transaction_cost = row["äº¤æ˜“æˆæœ¬"]

        if ticker not in fifo_positions:
            fifo_positions[ticker] = deque()
            fifo_realized_pnl_data[ticker] = 0.0

        if shares > 0:  # è²·é€²
            # ğŸ”§ ä¿®æ­£ï¼šè¨ˆç®—å«äº¤æ˜“æˆæœ¬çš„å¯¦éš›æ¯è‚¡æˆæœ¬
            actual_cost_per_share = (price * shares + transaction_cost) / shares

            fifo_positions[ticker].append({
                "shares": shares,
                "price": actual_cost_per_share,  # ğŸ”§ ä¿®æ­£ï¼šä½¿ç”¨å«äº¤æ˜“æˆæœ¬çš„æ¯è‚¡æˆæœ¬
                "original_price": price,  # ä¿ç•™åŸå§‹åƒ¹æ ¼ç”¨æ–¼è¨ˆç®—
                "fx": fx,
                "transaction_cost": transaction_cost,
                "currency": currency  # âœ… æ–°å¢é€™è¡Œï¼Œä¿ç•™ç•¶æ™‚çš„å¹£åˆ¥
            })
        else:  # è³£å‡º
            shares_to_sell = -shares
            realized_pnl = 0.0

            while shares_to_sell > 0 and fifo_positions[ticker]:
                lot = fifo_positions[ticker][0]
                lot_shares = lot["shares"]
                lot_price = lot["price"]  # å·²å«äº¤æ˜“æˆæœ¬çš„æˆæœ¬
                lot_fx = lot["fx"]

                matched_shares = min(lot_shares, shares_to_sell)

                # ğŸ”§ ä¿®æ­£ï¼šè³£å‡ºæç›Šè¨ˆç®—ï¼ˆæ‰£é™¤äº¤æ˜“æˆæœ¬ï¼‰
                gross_proceeds = price * matched_shares  # ç¸½æ”¶å…¥
                net_proceeds = gross_proceeds - (transaction_cost * matched_shares / abs(shares))  # æ‰£é™¤æ¯”ä¾‹äº¤æ˜“æˆæœ¬
                cost_basis = lot_price * matched_shares  # æˆæœ¬åŸºç¤ï¼ˆå·²å«è²·é€²æ™‚äº¤æ˜“æˆæœ¬ï¼‰

                pnl_foreign = net_proceeds - cost_basis
                realized_pnl += pnl_foreign * lot_fx

                if lot_shares <= shares_to_sell:
                    fifo_positions[ticker].popleft()
                else:
                    lot["shares"] -= matched_shares

                shares_to_sell -= matched_shares

            fifo_realized_pnl_data[ticker] += realized_pnl

    # è¨ˆç®—åº«å­˜æ˜ç´°
    for ticker, lots in fifo_positions.items():
        if lots:
            # âœ… å…ˆæŠ“å¹£åˆ¥èˆ‡æœ€æ–°åŒ¯ç‡ï¼ˆå¾ˆé—œéµï¼ï¼‰
            currency = lots[0]["currency"]
            latest_fx = get_latest_fx_rate(currency, fx_data_dict)

            # ğŸ”§ ä¿®æ­£ï¼šæ­£ç¢ºè¨ˆç®—å„é …æ•¸å€¼
            total_shares = sum(lot["shares"] for lot in lots)

            # è¨ˆç®—æœªå«äº¤æ˜“æˆæœ¬çš„ç¸½æˆæœ¬ï¼ˆç”¨æ–¼é¡¯ç¤ºæ¯”è¼ƒï¼‰
            pure_cost_foreign_total = sum(lot["original_price"] * lot["shares"] for lot in lots)

            # è¨ˆç®—å«äº¤æ˜“æˆæœ¬çš„ç¸½æˆæœ¬ï¼ˆåŸå¹£ï¼‰
            total_cost_foreign = sum(lot["price"] * lot["shares"] for lot in lots)

            # è¨ˆç®—å«äº¤æ˜“æˆæœ¬çš„ç¸½æˆæœ¬ï¼ˆå°å¹£ï¼‰
            total_cost_twd = sum(lot["price"] * lot["shares"] * lot["fx"] for lot in lots)

            # ğŸ”§ ä¿®æ­£ï¼šå¹³å‡åŒ¯ç‡æˆæœ¬ = ç¸½æˆæœ¬(å°å¹£) / ç¸½æˆæœ¬(åŸå¹£)
            avg_fx = total_cost_twd / total_cost_foreign if total_cost_foreign != 0 else 1.0

            # å¹³å‡æˆæœ¬ï¼ˆå«äº¤æ˜“æˆæœ¬ï¼‰
            avg_cost = total_cost_foreign / total_shares if total_shares > 0 else 0

            # å¹³å‡æˆæœ¬ï¼ˆæœªå«äº¤æ˜“æˆæœ¬ï¼Œç”¨æ–¼æ¯”è¼ƒï¼‰
            avg_cost_pure = pure_cost_foreign_total / total_shares if total_shares > 0 else 0

            # ğŸ”§ ä¿®æ­£ï¼šç²å–æœ€æ–°åƒ¹æ ¼
            if latest_prices and ticker in latest_prices:
                latest_price = latest_prices[ticker]
            else:
                try:
                    data = yf.download(ticker, period="5d", interval="1d", auto_adjust=True, progress=False)
                    latest_price = float(data["Close"].dropna().iloc[-1]) if not data.empty else np.nan
                except:
                    latest_price = np.nan

            # ğŸ”§ ä¿®æ­£ï¼šç²å–æœ€æ–°åŒ¯ç‡ï¼ˆæ ¹æ“šå¹£åˆ¥åˆ¤æ–·ï¼‰
            latest_fx = get_latest_fx_rate(currency, fx_data_dict)

            # è¨ˆç®—å¸‚å€¼
            market_value_foreign = latest_price * total_shares if not np.isnan(latest_price) else 0
            market_value_twd = market_value_foreign * latest_fx

            # ğŸ”§ ä¿®æ­£ï¼šæç›Šè¨ˆç®—
            # æœªå¯¦ç¾æŠ•è³‡æç›Š(åŸå¹£) = (ç¾åƒ¹ - å¹³å‡æˆæœ¬) * æŒæœ‰è‚¡æ•¸
            unrealized_foreign = (latest_price - avg_cost) * total_shares if not np.isnan(latest_price) else 0

            # æœªå¯¦ç¾æŠ•è³‡æç›Š(å°å¹£) = æœªå¯¦ç¾æŠ•è³‡æç›Š(åŸå¹£) * å¹³å‡åŒ¯ç‡æˆæœ¬->æ”¹æˆæœ€æ–°åŒ¯ç‡
            unrealized_twd = unrealized_foreign * latest_fx

            # æœªå¯¦ç¾ç¸½æç›Š(å°å¹£) = å¸‚å€¼(å°å¹£) - ç¸½æˆæœ¬(å°å¹£)
            total_unrealized_twd = market_value_twd - total_cost_twd

            # æœªå¯¦ç¾åŒ¯ç‡æç›Š(å°å¹£) = æœªå¯¦ç¾ç¸½æç›Š(å°å¹£) - æœªå¯¦ç¾æŠ•è³‡æç›Š(å°å¹£)
            fx_unrealized_twd = total_unrealized_twd - unrealized_twd

            fifo_position_list.append({
                "è‚¡ç¥¨ä»£è™Ÿ": ticker,
                "å¹£åˆ¥": currency,
                "æŒæœ‰è‚¡æ•¸": total_shares,
                "å¹³å‡æˆæœ¬(åŸå¹£)(æœªå«äº¤æ˜“æˆæœ¬)": avg_cost_pure,
                "å¹³å‡æˆæœ¬(åŸå¹£)": avg_cost,
                "å¹³å‡åŒ¯ç‡æˆæœ¬": avg_fx,  # ğŸ”§ ä¿®æ­£å¾Œçš„å¹³å‡åŒ¯ç‡æˆæœ¬
                "ç¸½æˆæœ¬(åŸå¹£)": total_cost_foreign,
                "ç¸½æˆæœ¬(å°å¹£)": total_cost_twd,
                "æœ€æ–°åŒ¯ç‡": latest_fx,
                "ç¾åƒ¹(åŸå¹£)": latest_price,
                "ç¾åƒ¹(å°å¹£)": latest_price * latest_fx if not np.isnan(latest_price) else 0,
                "å¸‚å€¼(åŸå¹£)": market_value_foreign,
                "å¸‚å€¼(å°å¹£)": market_value_twd,
                "æœªå¯¦ç¾æŠ•è³‡æç›Š(åŸå¹£)": unrealized_foreign,
                "æœªå¯¦ç¾æŠ•è³‡æç›Š(å°å¹£)": unrealized_twd,
                "æœªå¯¦ç¾ç¸½æç›Š(å°å¹£)": total_unrealized_twd,
                "æœªå¯¦ç¾æŠ•è³‡åŒ¯ç‡æç›Š(å°å¹£)": fx_unrealized_twd
            })

    return pd.DataFrame(fifo_position_list), fifo_realized_pnl_data


# âœ… åœ¨æ‚¨çš„ä¸»ç¨‹å¼ä¸­ï¼Œè«‹å°‡åŸæœ¬çš„ FIFO è¨ˆç®—éƒ¨åˆ†æ›¿æ›ç‚ºï¼š

# è¨ˆç®— FIFO åº«å­˜æ˜ç´°ï¼ˆä½¿ç”¨ä¿®æ­£å¾Œçš„å‡½æ•¸ï¼‰
fifo_position_df, fifo_realized_pnl_data = build_fifo_inventory_with_cost_fixed(
    df_trades, fx_data_dict, latest_prices
)

# âœ… é¡¯ç¤ºä¿®æ­£å¾Œçš„ FIFO æ˜ç´°è¡¨
print("\n" + "="*80)
print("ğŸ“Š åº«å­˜æ˜ç´°è¡¨ï¼ˆFIFOæ³•ï¼Œä¿®æ­£å¾Œå«äº¤æ˜“æˆæœ¬ï¼‰")
if not fifo_position_df.empty:
    print(fifo_position_df.to_string(index=False))

    # ğŸ”§ é©—è­‰ï¼šæ¯”è¼ƒå¹³å‡æˆæœ¬æ³•èˆ‡FIFOæ³•çš„å¹³å‡åŒ¯ç‡æˆæœ¬
    print("\nğŸ” å¹³å‡åŒ¯ç‡æˆæœ¬æ¯”è¼ƒé©—è­‰ï¼š")
    if not position_df.empty:
        for ticker in fifo_position_df["è‚¡ç¥¨ä»£è™Ÿ"].unique():
            if ticker in position_df["è‚¡ç¥¨ä»£è™Ÿ"].values:
                avg_fx_avg = position_df[position_df["è‚¡ç¥¨ä»£è™Ÿ"]==ticker]["å¹³å‡åŒ¯ç‡æˆæœ¬"].iloc[0]
                avg_fx_fifo = fifo_position_df[fifo_position_df["è‚¡ç¥¨ä»£è™Ÿ"]==ticker]["å¹³å‡åŒ¯ç‡æˆæœ¬"].iloc[0]
                print(f"  {ticker}: å¹³å‡æˆæœ¬æ³•={avg_fx_avg:.4f}, FIFOæ³•={avg_fx_fifo:.4f}")
else:
    print("ç›®å‰ç„¡æŒè‚¡ï¼ˆFIFOï¼‰")


# âœ… é¡¯ç¤º FIFO å·²å¯¦ç¾æç›Š
print("\nğŸ’° FIFO å·²å¯¦ç¾æç›Š")
total_fifo_realized = sum(fifo_realized_pnl_data.values())
print(f"ç¸½è¨ˆï¼šNT$ {total_fifo_realized:,.0f}")


# âœ… æŠ•è³‡çµ„åˆæ‘˜è¦
print(f"\n" + "="*80)
print(f"ğŸ“ˆ æŠ•è³‡çµ„åˆæ‘˜è¦ï¼ˆå¹³å‡æˆæœ¬æ³•ï¼Œå«äº¤æ˜“æˆæœ¬ï¼‰")
if not position_df.empty:
    total_twd_cost = position_df["ç¸½æˆæœ¬(å°å¹£)"].sum()
    total_twd_value = position_df["å¸‚å€¼(å°å¹£)"].sum()
    total_unrealized_pnl = position_df["æœªå¯¦ç¾ç¸½æç›Š(å°å¹£)"].sum()

    print(f"ç¸½æŠ•è³‡æˆæœ¬ï¼ˆå«äº¤æ˜“æˆæœ¬ï¼‰ï¼šNT$ {total_twd_cost:,.0f}")
    print(f"ç›®å‰å¸‚å€¼ï¼šNT$ {total_twd_value:,.0f}")
    print(f"æœªå¯¦ç¾æç›Šï¼šNT$ {total_unrealized_pnl:,.0f}")
    if total_twd_cost > 0:
        print(f"å ±é…¬ç‡ï¼š{(total_unrealized_pnl/total_twd_cost)*100:.2f}%")

    # æŒ‰å¹£åˆ¥åˆ†é¡é¡¯ç¤º
    currency_summary = position_df.groupby("å¹£åˆ¥").agg({
        "ç¸½æˆæœ¬(å°å¹£)": "sum",
        "å¸‚å€¼(å°å¹£)": "sum",
        "æœªå¯¦ç¾ç¸½æç›Š(å°å¹£)": "sum"
    }).round(0)
    currency_summary["å ±é…¬ç‡(%)"] = (
        currency_summary["æœªå¯¦ç¾ç¸½æç›Š(å°å¹£)"] / currency_summary["ç¸½æˆæœ¬(å°å¹£)"] * 100
    ).round(2)

    print(f"\nğŸ“Š æŒ‰å¹£åˆ¥åˆ†é¡ï¼š")
    print(currency_summary.to_string())

# é¡¯ç¤ºå·²å¯¦ç¾æç›Šæ‘˜è¦
if not realized_df.empty:
    total_realized_pnl = realized_df["å·²å¯¦ç¾ç¸½æç›Š(å°å¹£)"].sum()
    print(f"\nğŸ’° å·²å¯¦ç¾æç›Šç¸½è¨ˆï¼šNT$ {total_realized_pnl:,.0f}")

# âœ… ç¸½æŠ•è³‡ç¸¾æ•ˆæ‘˜è¦
print(f"\n" + "="*80)
print(f"ğŸ¯ ç¸½æŠ•è³‡ç¸¾æ•ˆæ‘˜è¦")
total_unrealized = total_unrealized_pnl if not position_df.empty else 0
total_realized = total_realized_pnl if not realized_df.empty else 0
total_pnl = total_unrealized + total_realized
total_cost = total_twd_cost if not position_df.empty else 0

print(f"æœªå¯¦ç¾æç›Šï¼šNT$ {total_unrealized:,.0f}")
print(f"å·²å¯¦ç¾æç›Šï¼šNT$ {total_realized:,.0f}")
print(f"ç¸½æç›Šï¼šNT$ {total_pnl:,.0f}")
if total_cost > 0:
    print(f"ç¸½æŠ•è³‡å ±é…¬ç‡ï¼š{(total_pnl/total_cost)*100:.2f}%")

#colab update
#!pip install xlsxwriter #streamlit-remove

# âœ… è¼¸å‡ºè‡³ Excel å ±è¡¨

#colab update
#output_file = "C:\\Users\\frankyeh\\Documents\\funds\\æŠ•è³‡åˆ†æå ±è¡¨.xlsx"
output_file = "/content/æŠ•è³‡åˆ†æå ±è¡¨.xlsx"
with pd.ExcelWriter(output_file, engine='xlsxwriter') as writer:
    # è²·è³£æ˜ç´°
    display_df.to_excel(writer, sheet_name="è²·è³£æ˜ç´°", index=False)

    # åº«å­˜æ˜ç´°ï¼ˆå¹³å‡æˆæœ¬æ³•ï¼‰
    if not position_df.empty:
        position_df.to_excel(writer, sheet_name="åº«å­˜æ˜ç´°_å¹³å‡æˆæœ¬æ³•", index=False)

    # åº«å­˜æ˜ç´°ï¼ˆFIFOæ³•ï¼‰
    if not fifo_position_df.empty:
        fifo_position_df.to_excel(writer, sheet_name="åº«å­˜æ˜ç´°_FIFOæ³•", index=False)

    # å·²å¯¦ç¾æç›Š
    if not realized_df.empty:
        realized_df.to_excel(writer, sheet_name="å·²å¯¦ç¾æç›Š", index=False)

    # äº¤æ˜“æˆæœ¬çµ±è¨ˆ
    if not cost_df.empty:
        cost_df.to_excel(writer, sheet_name="äº¤æ˜“æˆæœ¬çµ±è¨ˆ", index=False)

print(f"\nâœ… æŠ•è³‡åˆ†æå ±è¡¨å·²è¼¸å‡ºè‡³ï¼š{output_file}")



#colab update
files.download(output_file)



# ============================================================
# ğŸ§® æŠ•çµ„ã€Œæ¯æ—¥ã€ç¸½å½™æ•´ï¼ˆå¹³å‡æˆæœ¬æ³•ï¼›è·‘åˆ°ä»Šå¤©ï¼Œå°ç£æ™‚é–“ï¼›é¸é …Aï¼‹æœ€å¾Œæ—¥å¼·åˆ¶å°é½Šåº«å­˜å£å¾‘ï¼‰
# ç›®çš„ï¼šæœ€å¾Œä¸€å¤©çš„æœªå¯¦ç¾ç¸½æç›Š(å°å¹£) èˆ‡ã€Šåº«å­˜æ˜ç´°_å¹³å‡æˆæœ¬æ³•ã€‹åŠ ç¸½ä¸€è‡´
# æ–¹å¼ï¼š
#  - æ¯æ—¥ï¼šä»ç”¨æ­·å²æ”¶ç›¤ï¼‹åŒ¯ç‡ ffill
#  - æœ€å¾Œä¸€å¤©ï¼šç¾åƒ¹æ”¹ç”¨ latest_pricesï¼ŒåŒ¯ç‡æ”¹ç”¨ get_latest_fx_rateï¼ˆèˆ‡åº«å­˜ä¸€è‡´ï¼‰
#  - æœªå¯¦ç¾æç›Šå£å¾‘ = é€æª”åŠ ç¸½ï¼ˆå¸‚å€¼=ç¾åƒ¹Ã—è‚¡æ•¸Ã—æœ€æ–°åŒ¯ç‡ï¼›æˆæœ¬=pos["total_cost_twd"]ï¼‰
# ä¾è³´ï¼šdf, df_trades, stock_data_dict, fx_data_dict, min_date, latest_prices, position_df,
#      ä»¥åŠ get_latest_fx_rate(currency, fx_data_dict) å·²å­˜åœ¨ï¼ˆä½ å‰é¢ä¸»ç¨‹å¼æœ‰ï¼‰
# ============================================================

import pandas as pd
import numpy as np

# ---- A) ä»¥å°ç£æ™‚é–“å–å¾—ä»Šå¤©ï¼Œå»ºç«‹ all_dates ----
today_tw = pd.Timestamp.today(tz="Asia/Taipei").normalize().tz_localize(None)
start_date = pd.to_datetime(min_date).normalize()
desired_end_date = today_tw
all_dates = pd.date_range(start_date, desired_end_date, freq="D")
print(f"ğŸ”š æŠ•çµ„ç¸½é¡_æ—¥å ± è¨ˆç®—è‡³ä»Šå¤©ï¼ˆå°ç£æ™‚é–“ï¼‰ï¼š{desired_end_date.date()}")

# ---- B) æº–å‚™é€æ—¥æ”¶ç›¤åƒ¹ï¼ˆffillï¼‰----
stock_close_daily = {}
for tkr, sdf in stock_data_dict.items():
    if sdf is None or len(sdf) == 0:
        continue
    ser = sdf.set_index("æ—¥æœŸ")["æ”¶ç›¤åƒ¹"].sort_index()
    ser.index = pd.to_datetime(ser.index).normalize()
    ser = ser.reindex(all_dates).ffill()
    stock_close_daily[tkr] = ser

# ---- C) æº–å‚™é€æ—¥åŒ¯ç‡ï¼ˆTWD=1.0ï¼›ffillï¼‰----
fx_daily = {"TWD": pd.Series(1.0, index=all_dates)}
for cur, fdf in fx_data_dict.items():
    if fdf is None or len(fdf) == 0:
        continue
    ser = fdf.set_index("æ—¥æœŸ")["åŒ¯ç‡"].sort_index()
    ser.index = pd.to_datetime(ser.index).normalize()
    ser = ser.reindex(all_dates).ffill()
    fx_daily[cur] = ser

# ---- D) æ¯æ—¥ç¾é‡‘ï¼ˆé ç®—é¤˜é¡ï¼‰å»é‡ï¼†éå»¶ ----
if "é ç®—é¤˜é¡" in df.columns:
    cash_series = df[["æ—¥æœŸ", "é ç®—é¤˜é¡"]].dropna(subset=["æ—¥æœŸ"]).copy()
    cash_series["æ—¥æœŸ"] = pd.to_datetime(cash_series["æ—¥æœŸ"]).dt.normalize()
    cash_series["é ç®—é¤˜é¡"] = pd.to_numeric(cash_series["é ç®—é¤˜é¡"], errors="coerce")

    cash_by_day_unique = (
        cash_series.sort_values(["æ—¥æœŸ"])
        .drop_duplicates(subset=["æ—¥æœŸ"], keep="last")
        .set_index("æ—¥æœŸ")["é ç®—é¤˜é¡"]
    )
    cash_by_day = cash_by_day_unique.reindex(all_dates).ffill().fillna(0.0)
else:
    print("âš ï¸ åŸå§‹è³‡æ–™æœªæ‰¾åˆ°ã€Œé ç®—é¤˜é¡ã€ï¼Œç¾é‡‘éƒ¨ä½(å°å¹£) å°‡ä»¥ 0 è™•ç†")
    cash_by_day = pd.Series(0.0, index=all_dates)

# ---- E) é€æ—¥å›æ”¾äº¤æ˜“ï¼ˆå¹³å‡æˆæœ¬æ³•ã€å«äº¤æ˜“æˆæœ¬ï¼‰----
trades_sorted = df_trades.sort_values("æ—¥æœŸ").copy()
trades_sorted["æ—¥æœŸ"] = trades_sorted["æ—¥æœŸ"].dt.normalize()
trades_by_day = {d: g for d, g in trades_sorted.groupby("æ—¥æœŸ")}

# {ticker: {shares, avg_cost_foreign, pure_cost_foreign_total, avg_fx, total_cost_twd, currency}}
positions = {}
cum_realized_twd = 0.0

daily_rows = []
last_day = all_dates[-1]

# ç”¨æ–¼æœ€å¾Œä¸€å¤©ï¼šå¹£åˆ¥â†’æœ€æ–°åŒ¯ç‡ï¼ˆèˆ‡åº«å­˜åŒå£å¾‘ï¼‰
latest_fx_map = {}
# ä½¿ç”¨ä½ ä¸»ç¨‹å¼çš„ get_latest_fx_rateï¼ˆè‹¥ä¸å­˜åœ¨ï¼Œé€€è€Œå– fx_daily æœ€å¾Œå€¼ï¼‰
def _get_latest_fx_safe(cur):
    try:
        return float(get_latest_fx_rate(cur, fx_data_dict))
    except Exception:
        s = fx_daily.get(cur)
        return float(s.iloc[-1]) if s is not None and len(s) else (1.0 if cur == "TWD" else np.nan)

for cur in set([ "TWD" ] + [ v.get("å¹£åˆ¥", "TWD") for _,v in positions.items() ]):
    latest_fx_map[cur] = _get_latest_fx_safe(cur)

# é€æ—¥
for day in all_dates:
    # 1) ç•¶æ—¥äº¤æ˜“
    if day in trades_by_day:
        for _, r in trades_by_day[day].iterrows():
            tkr = r["è‚¡ç¥¨ä»£è™Ÿ"]; sh  = r["è³¼è²·è‚¡æ•¸"]; px  = r["è³¼è²·è‚¡åƒ¹"]
            ccy = r["å¹£åˆ¥"];     fx0 = r["æ›åŒ¯åŒ¯ç‡"] if pd.notna(r["æ›åŒ¯åŒ¯ç‡"]) else 1.0
            fee = r["äº¤æ˜“æˆæœ¬"] if pd.notna(r["äº¤æ˜“æˆæœ¬"]) else 0.0

            if tkr not in positions:
                positions[tkr] = {
                    "shares": 0.0,
                    "avg_cost_foreign": 0.0,
                    "pure_cost_foreign_total": 0.0,
                    "avg_fx": 0.0,
                    "total_cost_twd": 0.0,
                    "currency": ccy
                }
            pos = positions[tkr]

            if sh > 0:
                actual_cost_per_share = (px * sh + fee) / sh
                pos["pure_cost_foreign_total"] += px * sh
                new_total_shares = pos["shares"] + sh
                new_total_cost_foreign = pos["avg_cost_foreign"] * pos["shares"] + actual_cost_per_share * sh
                new_total_cost_twd     = pos["total_cost_twd"] + (actual_cost_per_share * sh * fx0)
                if new_total_shares > 0:
                    pos["avg_cost_foreign"] = new_total_cost_foreign / new_total_shares
                    pos["avg_fx"] = (new_total_cost_twd / new_total_cost_foreign) if new_total_cost_foreign != 0 else 1.0
                pos["shares"] = new_total_shares
                pos["total_cost_twd"] = new_total_cost_twd
            else:
                sell_shares = abs(sh)
                if pos["shares"] >= sell_shares and pos["shares"] > 0:
                    gross_proceeds = px * sell_shares
                    net_proceeds   = gross_proceeds - fee
                    cost_basis_f   = pos["avg_cost_foreign"] * sell_shares
                    realized_f     = net_proceeds - cost_basis_f
                    realized_twd   = realized_f * pos["avg_fx"]
                    cum_realized_twd += realized_twd
                    cost_pure_foreign = (pos["pure_cost_foreign_total"] / pos["shares"]) * sell_shares
                    pos["pure_cost_foreign_total"] -= cost_pure_foreign
                    pos["shares"] -= sell_shares
                    if pos["shares"] > 0:
                        pos["total_cost_twd"] = pos["avg_cost_foreign"] * pos["shares"] * pos["avg_fx"]
                    else:
                        pos["total_cost_twd"] = 0.0
                        pos["avg_cost_foreign"] = 0.0
                        pos["pure_cost_foreign_total"] = 0.0
                else:
                    print(f"âš ï¸ {tkr} {day.date()} è³£å‡ºè‚¡æ•¸ {sell_shares} > æŒæœ‰ {pos['shares']}ï¼Œå·²ç•¥é")

    # 2) ç•¶æ—¥ä¼°å€¼ï¼ˆé¸é …Aå£å¾‘ï¼‰
    total_market_value_twd = 0.0
    total_cost_twd         = 0.0
    unrealized_invest_twd  = 0.0

    for tkr, pos in positions.items():
        if pos["shares"] <= 0:
            continue
        ccy = pos["currency"]

        # --- é—œéµï¼šæœ€å¾Œä¸€å¤©å¼·åˆ¶å°é½Šåº«å­˜å£å¾‘ ---
        if day == last_day:
            # åŒåº«å­˜ç”¨çš„æœ€æ–°ã€Œç¾åƒ¹ã€èˆ‡ã€ŒåŒ¯ç‡ã€
            px_today = latest_prices.get(tkr, np.nan) if 'latest_prices' in globals() else np.nan
            if np.isnan(px_today):
                # å¾Œå‚™ï¼šä»ç”¨ ffill æ”¶ç›¤åƒ¹
                px_today = float(stock_close_daily.get(tkr, pd.Series(index=all_dates)).get(day, np.nan))
            fx_today = _get_latest_fx_safe(ccy)
        else:
            # å…¶ä»–æ—¥ç”¨ ffill æ™‚åº
            px_today = float(stock_close_daily.get(tkr, pd.Series(index=all_dates)).get(day, np.nan))
            fx_today = float(fx_daily.get(ccy, pd.Series(index=all_dates)).get(day, np.nan))

        if np.isnan(px_today) or np.isnan(fx_today):
            continue

        # å¸‚å€¼ï¼šç¾åƒ¹ Ã— è‚¡æ•¸ Ã— æœ€æ–°åŒ¯ç‡
        mv_twd = px_today * pos["shares"] * fx_today
        total_market_value_twd += mv_twd

        # æˆæœ¬ï¼šç´¯åŠ æŒå€‰å°å¹£æˆæœ¬
        total_cost_twd += pos["total_cost_twd"]

        # æŠ•è³‡ï¼ˆåƒ¹æ ¼ï¼‰å› å­
        unrealized_invest_twd += (px_today - pos["avg_cost_foreign"]) * pos["shares"] * fx_today

    unrealized_total_twd = total_market_value_twd - total_cost_twd
    unrealized_fx_twd    = unrealized_total_twd - unrealized_invest_twd

    cash_twd = float(cash_by_day.get(day, 0.0))
    total_equity_twd = cum_realized_twd + total_market_value_twd
    total_current_assets_twd = total_equity_twd + cash_twd

    daily_rows.append({
        "æ—¥æœŸ": day,
        "ç¸½æµå‹•è³‡ç”¢(å°å¹£)":           round(total_current_assets_twd, 0),
        "ç¸½æ¬Šç›Š(å°å¹£)":               round(total_equity_twd, 0),
        "ç¸½å¸‚å€¼(å°å¹£)":               round(total_market_value_twd, 0),
        "ç¸½æˆæœ¬(å°å¹£)":               round(total_cost_twd, 0),
        "å·²å¯¦ç¾æç›Š(å°å¹£)":            round(cum_realized_twd, 0),
        "æœªå¯¦ç¾ç¸½æç›Š(å°å¹£)":          round(unrealized_total_twd, 0),
        "æœªå¯¦ç¾æŠ•è³‡æç›Š(å°å¹£)":        round(unrealized_invest_twd, 0),
        "æœªå¯¦ç¾æŠ•è³‡åŒ¯ç‡æç›Š(å°å¹£)":    round(unrealized_fx_twd, 0),
        "ç¾é‡‘éƒ¨ä½(å°å¹£)":             round(cash_twd, 0)
    })

daily_portfolio_df = pd.DataFrame(daily_rows)

# ---- F) æ”¶å°¾ï¼šåˆ—å°æ ¸å°çµæœï¼ˆæœ€å¾Œä¸€å¤©ï¼‰----
last_day_row = daily_portfolio_df.iloc[-1]
daily_unreal = float(last_day_row["æœªå¯¦ç¾ç¸½æç›Š(å°å¹£)"])

pos_sum_unreal = None
if 'position_df' in globals() and isinstance(position_df, pd.DataFrame) and not position_df.empty:
    # ç›´æ¥ç”¨åº«å­˜è¡¨æ¬„ä½åŠ ç¸½
    if "æœªå¯¦ç¾ç¸½æç›Š(å°å¹£)" in position_df.columns:
        pos_sum_unreal = float(position_df["æœªå¯¦ç¾ç¸½æç›Š(å°å¹£)"].sum())
    else:
        # å¾Œå‚™ï¼šç”¨ å¸‚å€¼(å°å¹£)-ç¸½æˆæœ¬(å°å¹£) åŠ ç¸½
        pos_sum_unreal = float((position_df["å¸‚å€¼(å°å¹£)"] - position_df["ç¸½æˆæœ¬(å°å¹£)"]).sum())

print("\n" + "="*80)
print("ğŸ” æœ€å¾Œä¸€å¤©æœªå¯¦ç¾ç¸½æç›Š æ ¸å°")
print(f"daily_portfolio_dfï¼ˆæœ€å¾Œæ—¥ï¼‰: {daily_unreal:,.0f}")
if pos_sum_unreal is not None:
    print(f"position_df åŠ ç¸½        : {pos_sum_unreal:,.0f}")
    print(f"å·®ç•°                    : {daily_unreal - pos_sum_unreal:,.0f}")
else:
    print("ï¼ˆç„¡æ³•å–å¾— position_df åŠ ç¸½ä¾›å°æ¯”ï¼‰")

print("\nğŸ“† æŠ•çµ„æ¯æ—¥ç¸½å½™æ•´ï¼ˆå‰5åˆ—ï¼‰")
print(daily_portfolio_df.head().to_string(index=False))
print(f"...ï¼ˆå…± {len(daily_portfolio_df)} ç­†ï¼›æœ€å¾Œæ—¥æœŸ {daily_portfolio_df['æ—¥æœŸ'].max().date()}ï¼‰")







# æŠ•çµ„æ¯æ—¥ç¸½å½™æ•´ï¼ˆå°å¹£ï¼‰
# ========= Excel è¼¸å‡ºèˆ‡ä¸‹è¼‰ =========
# éœ€æ±‚ï¼šdisplay_df, position_df, fifo_position_df, realized_df, cost_df
# ï¼ˆå¦‚æœä½ æœ‰å»ºç«‹ daily_portfolio_dfï¼Œä¹Ÿæœƒä¸€ä½µè¼¸å‡ºï¼‰

# 1) å®‰è£ xlsxwriterï¼ˆColab é€šå¸¸å·²å¯ç”¨ï¼›é‡è·‘ä¹Ÿå®‰å…¨ï¼‰
try:
    import xlsxwriter  # noqa
except ImportError:
    import sys, subprocess
    subprocess.check_call([sys.executable, "-m", "pip", "install", "xlsxwriter"])

# 2) è¨­å®šè¼¸å‡ºè·¯å¾‘ï¼ˆColab å»ºè­°ç”¨ /contentï¼‰
#output_file = "/content/æŠ•è³‡åˆ†æå ±è¡¨.xlsx"

# 3) è¼¸å‡ºå„è¡¨åˆ°åŒä¸€ä»½ Excel
with pd.ExcelWriter(output_file, engine='xlsxwriter') as writer:
    # è²·è³£æ˜ç´°
    if 'display_df' in globals() and isinstance(display_df, pd.DataFrame) and not display_df.empty:
        display_df.to_excel(writer, sheet_name="è²·è³£æ˜ç´°", index=False)

    # åº«å­˜æ˜ç´°ï¼ˆå¹³å‡æˆæœ¬æ³•ï¼‰
    if 'position_df' in globals() and isinstance(position_df, pd.DataFrame) and not position_df.empty:
        position_df.to_excel(writer, sheet_name="åº«å­˜æ˜ç´°_å¹³å‡æˆæœ¬æ³•", index=False)

    # åº«å­˜æ˜ç´°ï¼ˆFIFOæ³•ï¼‰
    if 'fifo_position_df' in globals() and isinstance(fifo_position_df, pd.DataFrame) and not fifo_position_df.empty:
        fifo_position_df.to_excel(writer, sheet_name="åº«å­˜æ˜ç´°_FIFOæ³•", index=False)

    # å·²å¯¦ç¾æç›Š
    if 'realized_df' in globals() and isinstance(realized_df, pd.DataFrame) and not realized_df.empty:
        realized_df.to_excel(writer, sheet_name="å·²å¯¦ç¾æç›Š", index=False)

    # äº¤æ˜“æˆæœ¬çµ±è¨ˆ
    if 'cost_df' in globals() and isinstance(cost_df, pd.DataFrame) and not cost_df.empty:
        cost_df.to_excel(writer, sheet_name="äº¤æ˜“æˆæœ¬çµ±è¨ˆ", index=False)

    # æŠ•çµ„æ¯æ—¥ç¸½å½™æ•´ï¼ˆæˆ‘æä¾›çš„æ–°è¡¨ï¼›è‹¥ä½ æœ‰å»ºç«‹ daily_portfolio_dfï¼‰
    if 'daily_portfolio_df' in globals() and isinstance(daily_portfolio_df, pd.DataFrame) and not daily_portfolio_df.empty:
        daily_portfolio_df.to_excel(writer, sheet_name="æŠ•çµ„ç¸½é¡_æ—¥å ±", index=False)

print(f"\nâœ… æŠ•è³‡åˆ†æå ±è¡¨å·²è¼¸å‡ºè‡³ï¼š{output_file}")


#colab update
files.download(output_file)



# ================================
# âœ… è²·è³£æ˜ç´°ï¼šé€ç­†æ‹†åˆ†ï¼ˆå¹³å‡æˆæœ¬æ³•ï¼‰â€” æœ€çµ‚ç‰ˆé‚è¼¯
# è¦å‰‡ï¼š
# 1) è²·é€²åˆ—ã€Œæœ€çµ‚å·²å…¨æ•¸è³£å‡ºã€ï¼šå…­æ¬„çš† 0
# 2) è³£å‡ºåˆ—ï¼šåªè¨ˆç®—ã€Œå·²å¯¦ç¾ï¼ˆç¸½/æŠ•è³‡/åŒ¯ç‡ï¼‰ã€ï¼Œæœªå¯¦ç¾ä¸‰æ¬„ = 0
# 3) è²·é€²åˆ—ã€Œåˆ°è©•åƒ¹æ—¥ä»æœ‰å‰©ã€ï¼šåªè¨ˆç®—ã€Œæœªå¯¦ç¾ï¼ˆç¸½/æŠ•è³‡/åŒ¯ç‡ï¼‰ã€ï¼Œå·²å¯¦ç¾ä¸‰æ¬„ = 0
# èˆ‡åº«å­˜æ˜ç´°_å¹³å‡æˆæœ¬æ³•ä¸€è‡´çš„å£å¾‘ï¼ˆæœªå¯¦ç¾æŠ•è³‡ç”¨æœ€æ–°åŒ¯ç‡ã€ç¸½=å¸‚å€¼(æœ€æ–°åŒ¯ç‡)-æˆæœ¬(å¹³å‡åŒ¯ç‡)ï¼ŒåŒ¯ç‡æç›Š=ç¸½-æŠ•è³‡ï¼‰
# ================================

# å…ˆå»ºç«‹ 8 æ¬„ä½ã€é è¨­ 0
for col in [
    "å·²å¯¦ç¾ç¸½æç›Š(å°å¹£)", "å·²å¯¦ç¾æŠ•è³‡æç›Š(å°å¹£)", "å·²å¯¦ç¾æŠ•è³‡åŒ¯ç‡æç›Š(å°å¹£)",
    "æœªå¯¦ç¾ç¸½æç›Š(å°å¹£)", "æœªå¯¦ç¾æŠ•è³‡æç›Š(å°å¹£)", "æœªå¯¦ç¾æŠ•è³‡åŒ¯ç‡æç›Š(å°å¹£)",
    "æ¨™çš„è¡¡é‡æ—¥ç¾åƒ¹", "å¤–åŒ¯ç¾åƒ¹"
]:
    display_df[col] = 0.0

# å…¨åˆ—è£œä¸Šè©•åƒ¹æ—¥ç¾åƒ¹èˆ‡å¤–åŒ¯ç¾åƒ¹
display_df["æ¨™çš„è¡¡é‡æ—¥ç¾åƒ¹"] = display_df["è‚¡ç¥¨ä»£è™Ÿ"].map(latest_prices).astype(float)
display_df["å¤–åŒ¯ç¾åƒ¹"] = display_df["å¹£åˆ¥"].apply(lambda c: float(get_latest_fx_rate(c, fx_data_dict)) if pd.notna(c) else np.nan)

# ã€Œè³£å‡ºåˆ—ã€çš„å·²å¯¦ç¾ç´¯åŠ å™¨
sell_row_realized = {}  # idx -> {"real_total":..., "real_invest":..., "real_fx":...}
# ã€Œè²·é€²åˆ—ã€çš„æœªå¯¦ç¾ç´¯åŠ å™¨ï¼ˆåªæœ‰ remain>0 çš„è²·é€² lot æ‰æœƒå¯«å…¥ï¼‰
buy_row_unrealized = {} # idx -> {"unreal_total":..., "unreal_invest":..., "unreal_fx":...}

# é€æª”è™•ç†ï¼ˆå¹³å‡æˆæœ¬æ± ï¼‰
for ticker, g in df_trades.sort_values("æ—¥æœŸ").groupby("è‚¡ç¥¨ä»£è™Ÿ"):
    g = g.copy()
    currency   = g["å¹£åˆ¥"].iloc[0]
    latest_px  = latest_prices.get(ticker, np.nan)
    latest_fx  = get_latest_fx_rate(currency, fx_data_dict)

    # å¹³å‡æˆæœ¬æ± ï¼ˆå«äº¤æ˜“æˆæœ¬ï¼‰
    pool_shares = 0.0
    pool_avg_cost_foreign = 0.0
    pool_total_cost_foreign = 0.0
    pool_total_cost_twd = 0.0
    pool_avg_fx = 1.0

    # å°šæœ‰å‰©é¤˜çš„è²·é€² lotï¼š{"idx": åŸåˆ—index, "remain": shares}
    buy_lots = []

    for idx, row in g.iterrows():
        shares = float(row["è³¼è²·è‚¡æ•¸"])
        price  = float(row["è³¼è²·è‚¡åƒ¹"])
        tx_cost = float(row.get("äº¤æ˜“æˆæœ¬", 0.0))
        fx_used = float(row.get("æ›åŒ¯åŒ¯ç‡", 1.0))

        if shares > 0:
            # --- è²·é€²ï¼šæ›´æ–°å¹³å‡æˆæœ¬æ± ï¼ˆå«äº¤æ˜“æˆæœ¬ï¼‰
            actual_cost_per_share = (price * shares + tx_cost) / shares

            new_total_shares        = pool_shares + shares
            new_total_cost_foreign  = pool_total_cost_foreign + actual_cost_per_share * shares
            new_total_cost_twd      = pool_total_cost_twd     + actual_cost_per_share * shares * fx_used

            pool_shares = new_total_shares
            pool_total_cost_foreign = new_total_cost_foreign
            pool_total_cost_twd     = new_total_cost_twd
            pool_avg_cost_foreign   = (pool_total_cost_foreign / pool_shares) if pool_shares > 0 else 0.0
            pool_avg_fx             = (pool_total_cost_twd / pool_total_cost_foreign) if pool_total_cost_foreign > 0 else 1.0

            # è¨˜éŒ„è²·é€² lot
            buy_lots.append({"idx": idx, "remain": shares})

            # æŒ‰è¦å‰‡ï¼šè²·é€²åˆ—ä¸è¨˜å·²å¯¦ç¾ï¼›æœªå¯¦ç¾ç¨å¾Œä¾ remain>0 å†è¨ˆ

        else:
            # --- è³£å‡ºï¼šåªåœ¨ã€Œè³£å‡ºåˆ—ã€è¨ˆç®—å·²å¯¦ç¾ï¼›æœªå¯¦ç¾=0
            sell_qty = -shares
            if sell_qty <= 0 or pool_shares <= 0:
                continue

            # æ¯è‚¡æ·¨æ”¶å…¥(åŸå¹£)ï¼ˆè³£å‡ºæˆæœ¬æŒ‰æ¯”ä¾‹æ”¤åˆ°æ¯è‚¡ï¼‰
            net_per_share_foreign = price - (tx_cost / sell_qty)

            # å·²å¯¦ç¾ï¼ˆåŸå¹£ï¼‰
            real_invest_foreign = (price - pool_avg_cost_foreign) * sell_qty
            real_total_foreign  = (net_per_share_foreign - pool_avg_cost_foreign) * sell_qty

            # è½‰å°å¹£ï¼ˆèˆ‡ä¸»ç¨‹å¼ä¸€è‡´ï¼šç”¨ç•¶å‰æ± å­çš„å¹³å‡åŒ¯ç‡ï¼‰
            real_invest_twd = real_invest_foreign * pool_avg_fx
            real_total_twd  = real_total_foreign  * pool_avg_fx
            real_fx_twd     = real_total_twd - real_invest_twd

            if idx not in sell_row_realized:
                sell_row_realized[idx] = {"real_total": 0.0, "real_invest": 0.0, "real_fx": 0.0}
            sell_row_realized[idx]["real_invest"] += real_invest_twd
            sell_row_realized[idx]["real_total"]  += real_total_twd
            sell_row_realized[idx]["real_fx"]     += real_fx_twd

            # ç­‰æ¯”ä¾‹å¾è²·é€² lots æ‰£æ‰ï¼ˆåªç‚ºäº†çŸ¥é“å“ªäº›è²·é€²æœ€å¾Œæ˜¯å¦ remain>0ï¼‰
            total_open = sum(l["remain"] for l in buy_lots)
            if total_open > 0:
                left = sell_qty
                for i, lot in enumerate(buy_lots):
                    if lot["remain"] <= 0:
                        continue
                    # æ¯”ä¾‹åˆ†æ”¤ï¼›æœ€å¾Œä¸€å€‹åƒæ®˜å·®
                    q = min(lot["remain"], sell_qty * (lot["remain"] / total_open)) if i < len(buy_lots)-1 else min(lot["remain"], left)
                    q = float(q)
                    lot["remain"] -= q
                    left -= q
                    if left <= 1e-8:
                        break

            # æ›´æ–°å¹³å‡æˆæœ¬æ± ï¼šavg ä¸è®Šï¼Œåªæ¸›åº«å­˜èˆ‡ç¸½æˆæœ¬
            pool_shares -= sell_qty
            if pool_shares <= 1e-8:
                pool_shares = 0.0
                pool_total_cost_foreign = 0.0
                pool_total_cost_twd     = 0.0
                pool_avg_cost_foreign   = 0.0
                pool_avg_fx             = 1.0
            else:
                pool_total_cost_foreign = pool_avg_cost_foreign * pool_shares
                pool_total_cost_twd     = pool_avg_cost_foreign * pool_shares * pool_avg_fx

    # --- è©²è‚¡ç¥¨è™•ç†å®Œï¼šå°ä»æœ‰å‰©é¤˜çš„è²·é€² lotï¼ˆremain>0ï¼‰è¨ˆç®—ã€Œæœªå¯¦ç¾ã€ï¼Œå¯«åœ¨è²·é€²é‚£åˆ—
    if (latest_px is not None and not np.isnan(latest_px)) and (latest_fx is not None and not np.isnan(latest_fx)):
        for lot in buy_lots:
            remain = float(lot["remain"])
            if remain <= 0:
                # æ­¤è²·é€²æœ€çµ‚å·²å…¨æ•¸è³£å‡ºï¼šå…­æ¬„ä¿æŒ 0ï¼ˆä¸å¯«ï¼‰
                continue

            # èˆ‡åº«å­˜æ˜ç´°ä¸€è‡´çš„å£å¾‘
            unreal_invest_twd = (latest_px - pool_avg_cost_foreign) * remain * latest_fx
            unreal_total_twd  = (latest_px * latest_fx * remain) - (pool_avg_cost_foreign * pool_avg_fx * remain)
            unreal_fx_twd     = unreal_total_twd - unreal_invest_twd

            bidx = lot["idx"]
            if bidx not in buy_row_unrealized:
                buy_row_unrealized[bidx] = {"unreal_total": 0.0, "unreal_invest": 0.0, "unreal_fx": 0.0}
            buy_row_unrealized[bidx]["unreal_invest"] += unreal_invest_twd
            buy_row_unrealized[bidx]["unreal_total"]  += unreal_total_twd
            buy_row_unrealized[bidx]["unreal_fx"]     += unreal_fx_twd

# ===== å›å¡«åˆ° display_df =====
# è³£å‡ºåˆ—ï¼šåªå¯«å·²å¯¦ç¾ï¼›æœªå¯¦ç¾ä¿æŒ 0
for idx, v in sell_row_realized.items():
    display_df.loc[idx, "å·²å¯¦ç¾æŠ•è³‡æç›Š(å°å¹£)"]   = v["real_invest"]
    display_df.loc[idx, "å·²å¯¦ç¾ç¸½æç›Š(å°å¹£)"]     = v["real_total"]
    display_df.loc[idx, "å·²å¯¦ç¾æŠ•è³‡åŒ¯ç‡æç›Š(å°å¹£)"] = v["real_fx"]
    # æœªå¯¦ç¾ä¸‰æ¬„ç¶­æŒ 0ï¼ˆç¬¦åˆè¦å‰‡ï¼‰

# è²·é€²åˆ—ï¼šåªå¯«æœªå¯¦ç¾ï¼›å·²å¯¦ç¾ä¿æŒ 0
for idx, v in buy_row_unrealized.items():
    display_df.loc[idx, "æœªå¯¦ç¾æŠ•è³‡æç›Š(å°å¹£)"]   = v["unreal_invest"]
    display_df.loc[idx, "æœªå¯¦ç¾ç¸½æç›Š(å°å¹£)"]     = v["unreal_total"]
    display_df.loc[idx, "æœªå¯¦ç¾æŠ•è³‡åŒ¯ç‡æç›Š(å°å¹£)"] = v["unreal_fx"]

print("\nğŸ§¾ è²·è³£æ˜ç´°ï¼ˆä¾æœ€çµ‚ç‰ˆè¦å‰‡ï¼‰å‰ 12 åˆ—ï¼š")
print(display_df.head(12).to_string(index=False))



#colab update
#!pip install xlsxwriter #streamlit-remove

# âœ… è¼¸å‡ºè‡³ Excel å ±è¡¨ï¼ˆè²·è³£æ˜ç´°å« 6 å€‹æç›Šæ¬„ + 2 å€‹ç¾åƒ¹æ¬„ï¼‰
output_file = "/content/æŠ•è³‡åˆ†æå ±è¡¨.xlsx"
with pd.ExcelWriter(output_file, engine='xlsxwriter') as writer:
    display_df.to_excel(writer, sheet_name="è²·è³£æ˜ç´°", index=False)
    if not position_df.empty:
        position_df.to_excel(writer, sheet_name="åº«å­˜æ˜ç´°_å¹³å‡æˆæœ¬æ³•", index=False)
    if not fifo_position_df.empty:
        fifo_position_df.to_excel(writer, sheet_name="åº«å­˜æ˜ç´°_FIFOæ³•", index=False)
    if not realized_df.empty:
        realized_df.to_excel(writer, sheet_name="å·²å¯¦ç¾æç›Š", index=False)
    if not cost_df.empty:
        cost_df.to_excel(writer, sheet_name="äº¤æ˜“æˆæœ¬çµ±è¨ˆ", index=False)

print(f"\nâœ… æŠ•è³‡åˆ†æå ±è¡¨å·²è¼¸å‡ºè‡³ï¼š{output_file}")


#colab update
files.download(output_file)



# ================================
# ğŸ“¦ æŠ•è³‡æ¯”è¼ƒï¼šé¡åƒç¾é‡‘æµ + æ¯æœˆå®šé¡ 7 è¬ï¼ˆ6 çµ„ï¼‰
# éœ€æ±‚ï¼šä½¿ç”¨ä½ å‰é¢å·²ä¸‹è¼‰å¥½çš„ fx_data_dictã€stock_data_dictã€min_dateã€max_dateã€
#       determine_currency(), get_fx_rate(), download_stock_history() ç­‰å‡½å¼/ç‰©ä»¶
# æ³¨æ„ï¼šæœ¬å€å¡Šä¸æœƒæ”¹å‹•ä½ åŸæœ¬çš„ df_trades èˆ‡ä¸»æµç¨‹ï¼Œåªæ˜¯é¡å¤–å»º 6 çµ„æ¨¡æ“¬ç­–ç•¥
# ================================
import pandas as pd
import numpy as np
from datetime import datetime, timedelta
from dateutil.relativedelta import relativedelta

# ===== åƒæ•¸ï¼ˆå¯èª¿ï¼‰ =====
mirror_targets = {
    "SPY": "SPY",           # ç¾è‚¡ SPY
    "0050": "0050.TW",      # å…ƒå¤§å°ç£50ï¼ˆYahoo ç”¨ 0050.TWï¼‰
    "2330": "2330.TW"       # å°ç©é›»ï¼ˆYahoo ç”¨ 2330.TWï¼‰
}
dca_targets = {
    "SPY_DCA": "SPY",
    "0050_DCA": "0050.TW",
    "2330_DCA": "2330.TW"
}
monthly_amount_twd = 70000  # æ¯æœˆå®šé¡é‡‘é¡ï¼ˆå°å¹£ï¼‰
dca_day = 1                 # æ¯æœˆã€Œå¹¾è™Ÿã€å»è²·ï¼ˆè‹¥é‡éäº¤æ˜“æ—¥ï¼Œä½¿ç”¨æœ€è¿‘å¯ç”¨æ”¶ç›¤åƒ¹ï¼‰

# ===== è¼”åŠ©ï¼šå–å¾—æŸæ—¥æˆ–ä¹‹å‰æœ€è¿‘ä¸€æ—¥çš„æ”¶ç›¤åƒ¹ï¼ˆç”¨æ—¢æœ‰çš„ stock_data_dictï¼Œè‹¥ç¼ºå†ä¸‹è¼‰ï¼‰ =====
def get_price_on_or_before(date, ticker, stock_data_dict, min_date, max_date):
    if ticker not in stock_data_dict or stock_data_dict[ticker].empty:
        # å¦‚æœæ²’æŠ“éï¼Œè£œæŠ“ä¸€æ¬¡ï¼ˆæ‹‰é•·ä¸€é»æ—¥æœŸé¿å…ç¼ºæ¼ï¼‰
        _df = download_stock_history(ticker, min_date, max_date)
        stock_data_dict[ticker] = _df if not _df.empty else pd.DataFrame(columns=["æ—¥æœŸ", "æ”¶ç›¤åƒ¹", "è‚¡ç¥¨ä»£è™Ÿ"])

    sdf = stock_data_dict[ticker]
    if sdf.empty:
        return np.nan
    sdf = sdf.sort_values("æ—¥æœŸ")
    # å– <= æŒ‡å®šæ—¥æœŸ çš„æœ€è¿‘ä¸€ç­†
    mask = sdf["æ—¥æœŸ"] <= pd.to_datetime(date).normalize()
    if not mask.any():
        # è‹¥è©²æ—¥ä¹‹å‰éƒ½æ²’è³‡æ–™ï¼Œå–æœ€æ—©çš„ä¸€ç­†ï¼ˆé¿å… NaNï¼‰
        return float(sdf["æ”¶ç›¤åƒ¹"].iloc[0])
    return float(sdf.loc[mask, "æ”¶ç›¤åƒ¹"].iloc[-1])

# ===== è¼”åŠ©ï¼šæŠŠä¸€ç­†ã€Œå°å¹£ç¾é‡‘æµã€è½‰ç‚ºã€Œç›®æ¨™æ¨™çš„ è‚¡æ•¸/åƒ¹æ ¼/åŒ¯ç‡ã€çš„äº¤æ˜“ =====
def build_mirror_trade_row(trade_date, cash_twd, target_ticker, fx_data_dict, stock_data_dict, min_date, max_date):
    """
    cash_twd > 0 è¦–ç‚ºã€è²·é€²èŠ±è²»çš„å°å¹£ã€ï¼ˆæ”¯å‡ºï¼‰
    cash_twd < 0 è¦–ç‚ºã€è³£å‡ºæ”¶åˆ°çš„å°å¹£ã€ï¼ˆæ”¶å…¥ï¼›æ³¨æ„æœƒç”¢ç”Ÿè² è‚¡æ•¸ï¼‰
    äº¤æ˜“æˆæœ¬ï¼šç”¨èˆ‡åŸäº¤æ˜“ç›¸åŒçš„ã€å°å¹£é‡‘é¡ã€ï¼Œå†æŠ˜å›ç›®æ¨™æ¨™çš„çš„å¤–å¹£é‡‘é¡å¯«åœ¨ã€Œäº¤æ˜“æˆæœ¬ã€æ¬„ä½
    """
    target_ccy = determine_currency(target_ticker)
    px = get_price_on_or_before(trade_date, target_ticker, stock_data_dict, min_date, max_date)
    fx = get_fx_rate(pd.to_datetime(trade_date), target_ccy, fx_data_dict)
    if np.isnan(px) or np.isnan(fx) or px <= 0 or fx <= 0:
        return None

    # æ‹†åˆ†ã€Œæˆæœ¬ã€èˆ‡ã€Œæ·¨äº¤æ˜“é‡‘é¡ã€ï¼šæˆ‘å€‘åœ¨é¡åƒæ™‚ï¼ŒæŠŠã€åŸäº¤æ˜“çš„äº¤æ˜“æˆæœ¬(å°å¹£)ã€ä¿æŒç›¸åŒé‡‘é¡ï¼ˆå¯æ§ï¼‰
    # é€™éœ€è¦å‘¼å«ç«¯å…ˆå‚³é€²ã€Œä¸å«æˆæœ¬ã€èˆ‡ã€Œæˆæœ¬ã€çš„å°å¹£ã€‚ä¸‹æ–¹ mirror builder æœƒè™•ç†ã€‚
    # é€™å€‹å‡½å¼åªè² è²¬æŠŠï¼ˆä¸å«æˆæœ¬çš„å°å¹£é‡‘é¡ï¼‰æ›ç®—æˆã€Œè‚¡æ•¸ã€ã€‚
    return {"_ok": True, "px": px, "fx": fx, "ccy": target_ccy}

# ===== 1) é¡åƒä½ çš„æ¯ç­†ç¾é‡‘æµåˆ°å…¶ä»–æ¨™çš„ =====
def make_mirror_trades(df_trades, target_ticker, fx_data_dict, stock_data_dict, min_date, max_date):
    """
    ç”¨ã€åŒä¸€æ—¥æœŸã€åŒä¸€å°å¹£ç¾é‡‘é¡åº¦ï¼ˆå«ç›¸åŒå°å¹£äº¤æ˜“æˆæœ¬ï¼‰ã€ï¼Œä½†æŠŠæ¨™çš„æ”¹æˆ target_ticker
    è¼¸å‡ºä¸€å€‹ df_trades_altï¼ˆæ¬„ä½èˆ‡ä½ åŸæœ¬ df_trades å…¼å®¹ï¼‰
    """
    rows = []
    for _, r in df_trades.sort_values("æ—¥æœŸ").iterrows():
        d = pd.to_datetime(r["æ—¥æœŸ"]).normalize()
        shares = float(r["è³¼è²·è‚¡æ•¸"])
        price  = float(r["è³¼è²·è‚¡åƒ¹"])
        fx_used = float(r.get("æ›åŒ¯åŒ¯ç‡", 1.0))
        tx_cost_foreign = float(r.get("äº¤æ˜“æˆæœ¬", 0.0))

        # åŸå§‹å°å¹£é‡‘é¡ï¼ˆå«äº¤æ˜“æˆæœ¬ï¼‰
        gross_foreign = price * abs(shares)
        tx_cost_twd   = tx_cost_foreign * fx_used
        cash_twd_abs  = gross_foreign * fx_used + tx_cost_twd  # çµ•å°é‡‘é¡
        sign = 1 if shares > 0 else -1

        # æŸ¥è©¢ç›®æ¨™æ¨™çš„çš„ px/fx
        info = build_mirror_trade_row(d, cash_twd_abs * sign, target_ticker, fx_data_dict, stock_data_dict, min_date, max_date)
        if not info or not info.get("_ok", False):
            continue

        px_t = info["px"]
        fx_t = info["fx"]
        ccy_t = info["ccy"]

        # è®“ã€Œäº¤æ˜“æˆæœ¬(å°å¹£)ã€èˆ‡åŸäº¤æ˜“ç›¸åŒï¼›æŠ˜å›å¤–å¹£å¾Œå¡«å…¥ã€Œäº¤æ˜“æˆæœ¬ã€æ¬„ä½
        tx_cost_foreign_target = tx_cost_twd / fx_t

        # ã€Œä¸å«æˆæœ¬ã€çš„å°å¹£é‡‘é¡
        notional_twd_abs = gross_foreign * fx_used
        # å°æ‡‰æˆç›®æ¨™æ¨™çš„çš„è‚¡æ•¸ï¼ˆè²·æ­£ã€è³£è² ï¼‰
        shares_target = (notional_twd_abs / (px_t * fx_t)) * sign

        rows.append({
            "æ—¥æœŸ": d,
            "è‚¡ç¥¨ä»£è™Ÿ": target_ticker,
            "è³¼è²·è‚¡æ•¸": shares_target,                  # è²·æ­£ã€è³£è² 
            "è³¼è²·è‚¡åƒ¹": px_t,
            "æ›åŒ¯åŒ¯ç‡": fx_t,
            "äº¤æ˜“æˆæœ¬": tx_cost_foreign_target,         # å¤–å¹£
            "å¹£åˆ¥": ccy_t
        })

    df_alt = pd.DataFrame(rows)
    if not df_alt.empty:
        # èˆ‡ä½ çš„ä¸»ç¨‹å¼ä¸€è‡´ï¼šç¼ºæ¬„ä½è£œé½Š
        for col in ["æŠ•è³‡é‡‘é¡", "äº¤æ˜“é‡‘é¡"]:
            if col not in df_alt.columns:
                df_alt[col] = np.nan
    return df_alt

# ===== 2) æ¯æœˆå®šé¡ï¼ˆå°å¹£ï¼‰è²·å…¥è‡³æœŸæœ« =====
def make_monthly_dca_trades(start_date, end_date, amount_twd, target_ticker, fx_data_dict, stock_data_dict):
    rows = []
    cur = pd.to_datetime(start_date).replace(day=dca_day)
    end_date = pd.to_datetime(end_date)

    while cur <= end_date:
        # è©²æœˆç¬¬ dca_day å¤©ï¼Œæ‰¾è©²æ—¥æˆ–ä¹‹å‰æœ€è¿‘æ”¶ç›¤åƒ¹
        px = get_price_on_or_before(cur, target_ticker, stock_data_dict, start_date, end_date)
        ccy = determine_currency(target_ticker)
        fx  = get_fx_rate(cur, ccy, fx_data_dict)
        if (not np.isnan(px)) and (not np.isnan(fx)) and px > 0 and fx > 0:
            shares = (amount_twd / (px * fx))
            rows.append({
                "æ—¥æœŸ": cur.normalize(),
                "è‚¡ç¥¨ä»£è™Ÿ": target_ticker,
                "è³¼è²·è‚¡æ•¸": shares,      # DCA åªæœ‰è²·é€²
                "è³¼è²·è‚¡åƒ¹": px,
                "æ›åŒ¯åŒ¯ç‡": fx,
                "äº¤æ˜“æˆæœ¬": 0.0,         # å…ˆè¨­ 0ï¼›è‹¥ä½ è¦è‡ªè¨‚åˆ¸å•†è²»ï¼Œå¯åœ¨æ­¤åŠ ä¸Šæ¯”ä¾‹
                "å¹£åˆ¥": ccy
            })
        # ä¸‹ä¸€å€‹æœˆ
        cur = cur + relativedelta(months=1)

    df_dca = pd.DataFrame(rows)
    for col in ["æŠ•è³‡é‡‘é¡", "äº¤æ˜“é‡‘é¡"]:
        if col not in df_dca.columns:
            df_dca[col] = np.nan
    return df_dca

# ===== 3) ç”¨ä½ ä¸»ç¨‹å¼çš„ã€Œå¹³å‡æˆæœ¬æ³•é‚è¼¯ã€åšä¸€æ¬¡å¿«é€Ÿè©•åƒ¹ï¼ˆå°è£æˆå‡½å¼ï¼‰ =====
def evaluate_portfolio_fast(df_trades_like, fx_data_dict):
    """
    ä»¥ä½ ä¸»ç¨‹å¼çš„å¹³å‡æˆæœ¬æ¦‚å¿µå¿«é€Ÿè¨ˆç®—ï¼šposition_dfï¼ˆå«æœªå¯¦ç¾æç›Šï¼‰ã€realized_pnlã€ç¸½çµ
    æ³¨æ„ï¼šé€™è£¡ä¸è™•ç†è‚¡ç¥¨åˆ†å‰²èˆ‡ FIFOï¼ˆè‹¥è¦ä¹Ÿåšï¼Œå¯èª¿ç”¨ä½ ç¾æœ‰çš„é¡åˆ¥èˆ‡å‡½å¼å†åŒ…ä¸€å±¤ï¼‰
    """
    # --- å¹³å‡æˆæœ¬æ± 
    pos = {}            # ticker -> dict(shares, avg_cost_foreign, avg_fx, total_cost_twd, currency)
    realized = {}       # ticker -> realized_twd

    for _, row in df_trades_like.sort_values("æ—¥æœŸ").iterrows():
        tkr = row["è‚¡ç¥¨ä»£è™Ÿ"]
        sh  = float(row["è³¼è²·è‚¡æ•¸"])
        px  = float(row["è³¼è²·è‚¡åƒ¹"])
        fx  = float(row.get("æ›åŒ¯åŒ¯ç‡", 1.0))
        fee = float(row.get("äº¤æ˜“æˆæœ¬", 0.0))
        ccy = row.get("å¹£åˆ¥", determine_currency(tkr))

        if tkr not in pos:
            pos[tkr] = {"shares": 0.0, "avg_cost_foreign": 0.0, "avg_fx": 0.0, "total_cost_twd": 0.0, "currency": ccy}
            realized[tkr] = 0.0

        p = pos[tkr]
        if sh > 0:
            # è²·é€²ï¼ˆå«æˆæœ¬ï¼‰
            actual_cost_ps = (px * sh + fee) / sh
            new_shares = p["shares"] + sh
            new_cost_foreign = p["avg_cost_foreign"] * p["shares"] + actual_cost_ps * sh
            new_cost_twd     = p["total_cost_twd"] + actual_cost_ps * sh * fx

            p["shares"] = new_shares
            if new_shares > 0:
                p["avg_cost_foreign"] = new_cost_foreign / new_shares
                p["avg_fx"]           = new_cost_twd / new_cost_foreign
                p["total_cost_twd"]   = p["avg_cost_foreign"] * p["shares"] * p["avg_fx"]
            else:
                p["avg_cost_foreign"] = 0.0
                p["avg_fx"] = 1.0
                p["total_cost_twd"] = 0.0
        else:
            # è³£å‡ºï¼ˆæ‰£æˆæœ¬ feeï¼‰
            sell_qty = abs(sh)
            if p["shares"] < sell_qty or p["shares"] <= 0:
                continue
            gross = px * sell_qty
            net   = gross - fee
            invest_foreign = (px - p["avg_cost_foreign"]) * sell_qty
            total_foreign  = (net / sell_qty - p["avg_cost_foreign"]) * sell_qty
            invest_twd = invest_foreign * p["avg_fx"]
            total_twd  = total_foreign  * p["avg_fx"]
            realized[tkr] += total_twd

            # æ›´æ–°æŒå€‰æ•¸å€¼
            p["shares"] -= sell_qty
            if p["shares"] > 0:
                p["total_cost_twd"] = p["avg_cost_foreign"] * p["shares"] * p["avg_fx"]
            else:
                p["avg_cost_foreign"] = 0.0
                p["avg_fx"] = 1.0
                p["total_cost_twd"] = 0.0

    # --- ç”Ÿæˆ position_dfï¼ˆæŠ“æœ€æ–°åƒ¹èˆ‡åŒ¯ç‡ï¼Œç®—æœªå¯¦ç¾ï¼‰
    rows = []
    for tkr, p in pos.items():
        if p["shares"] <= 0:
            continue
        latest_px = get_price_on_or_before(max_date, tkr, stock_data_dict, min_date, max_date)
        latest_fx = get_latest_fx_rate(p["currency"], fx_data_dict)
        mv_foreign = latest_px * p["shares"]
        mv_twd     = mv_foreign * latest_fx
        unreal_invest_foreign = (latest_px - p["avg_cost_foreign"]) * p["shares"]
        unreal_invest_twd     = unreal_invest_foreign * latest_fx
        unreal_total_twd      = mv_twd - p["total_cost_twd"]
        unreal_fx_twd         = unreal_total_twd - unreal_invest_twd

        rows.append({
            "è‚¡ç¥¨ä»£è™Ÿ": tkr,
            "å¹£åˆ¥": p["currency"],
            "æŒæœ‰è‚¡æ•¸": p["shares"],
            "å¹³å‡æˆæœ¬(åŸå¹£)": p["avg_cost_foreign"],
            "å¹³å‡åŒ¯ç‡æˆæœ¬": p["avg_fx"],
            "ç¸½æˆæœ¬(å°å¹£)": p["total_cost_twd"],
            "æœ€æ–°åŒ¯ç‡": latest_fx,
            "ç¾åƒ¹(åŸå¹£)": latest_px,
            "å¸‚å€¼(å°å¹£)": mv_twd,
            "æœªå¯¦ç¾æŠ•è³‡æç›Š(å°å¹£)": unreal_invest_twd,
            "æœªå¯¦ç¾ç¸½æç›Š(å°å¹£)": unreal_total_twd,
            "æœªå¯¦ç¾æŠ•è³‡åŒ¯ç‡æç›Š(å°å¹£)": unreal_fx_twd
        })

    position_df_alt = pd.DataFrame(rows).sort_values("è‚¡ç¥¨ä»£è™Ÿ")
    realized_total_twd = sum(realized.values())
    total_cost_twd = float(position_df_alt["ç¸½æˆæœ¬(å°å¹£)"].sum()) if not position_df_alt.empty else 0.0
    total_mv_twd   = float(position_df_alt["å¸‚å€¼(å°å¹£)"].sum()) if not position_df_alt.empty else 0.0
    total_unreal_twd = float(position_df_alt["æœªå¯¦ç¾ç¸½æç›Š(å°å¹£)"].sum()) if not position_df_alt.empty else 0.0
    total_pnl_twd  = realized_total_twd + total_unreal_twd
    total_return   = (total_pnl_twd / total_cost_twd) if total_cost_twd > 0 else np.nan

    summary = {
        "ç¸½æˆæœ¬(å°å¹£)": total_cost_twd,
        "å¸‚å€¼(å°å¹£)": total_mv_twd,
        "æœªå¯¦ç¾æç›Š(å°å¹£)": total_unreal_twd,
        "å·²å¯¦ç¾æç›Š(å°å¹£)": realized_total_twd,
        "ç¸½æç›Š(å°å¹£)": total_pnl_twd,
        "å ±é…¬ç‡": total_return
    }
    return position_df_alt, realized, summary

# ===== 4) ç”¢ç”Ÿå…­çµ„ df_tradesï¼Œè¨ˆç®—è©•åƒ¹ï¼Œä¸¦è¼¸å‡º Excel å ±è¡¨ =====
comparison_results = []   # æ”¶é›† summary åšç¸½è¡¨
sheets = {}               # åç¨± -> DataFrameï¼ˆè²·è³£æ˜ç´°ï¼‰

# 4-1 é¡åƒç¾é‡‘æµ
for label, tgt in mirror_targets.items():
    df_m = make_mirror_trades(df_trades, tgt, fx_data_dict, stock_data_dict, min_date, max_date)
    # è©•åƒ¹
    pos_df_m, realized_m, summary_m = evaluate_portfolio_fast(df_m, fx_data_dict)
    # åšä¸€ä»½å¯è®€çš„ã€Œè²·è³£æ˜ç´°ã€ï¼ˆèˆ‡åŸ display_df æ¬„ä½é è¿‘ï¼‰
    disp = df_m.copy().sort_values("æ—¥æœŸ")
    disp["æ­·å²åŒ¯ç‡"] = disp["æ›åŒ¯åŒ¯ç‡"]
    disp = disp[["æ—¥æœŸ","è‚¡ç¥¨ä»£è™Ÿ","å¹£åˆ¥","è³¼è²·è‚¡æ•¸","è³¼è²·è‚¡åƒ¹","æ›åŒ¯åŒ¯ç‡","æ­·å²åŒ¯ç‡","äº¤æ˜“æˆæœ¬"]]
    sheets[f"é¡åƒ_{label}_è²·è³£æ˜ç´°"] = disp
    sheets[f"é¡åƒ_{label}_åº«å­˜æ‘˜è¦"] = pos_df_m
    # summary æ”¶é›†
    summary_row = {"ç­–ç•¥": f"é¡åƒ-{label}"}
    summary_row.update(summary_m)
    comparison_results.append(summary_row)

# 4-2 æ¯æœˆå®šé¡ DCA
for label, tgt in dca_targets.items():
    df_d = make_monthly_dca_trades(min_date, max_date, monthly_amount_twd, tgt, fx_data_dict, stock_data_dict)
    pos_df_d, realized_d, summary_d = evaluate_portfolio_fast(df_d, fx_data_dict)
    disp = df_d.copy().sort_values("æ—¥æœŸ")
    disp["æ­·å²åŒ¯ç‡"] = disp["æ›åŒ¯åŒ¯ç‡"]
    disp = disp[["æ—¥æœŸ","è‚¡ç¥¨ä»£è™Ÿ","å¹£åˆ¥","è³¼è²·è‚¡æ•¸","è³¼è²·è‚¡åƒ¹","æ›åŒ¯åŒ¯ç‡","æ­·å²åŒ¯ç‡","äº¤æ˜“æˆæœ¬"]]
    sheets[f"DCA_{label}_è²·è³£æ˜ç´°"] = disp
    sheets[f"DCA_{label}_åº«å­˜æ‘˜è¦"] = pos_df_d
    summary_row = {"ç­–ç•¥": f"DCA-{label.replace('_DCA','')}"}
    summary_row.update(summary_d)
    comparison_results.append(summary_row)

# 4-3 åŠ å…¥ä½ åŸæœ¬æŠ•çµ„çš„ summaryï¼ˆç”¨ä½ å‰é¢ä¸»ç¨‹å¼ç®—å¥½çš„ total_* è®Šæ•¸ï¼‰
try:
    base_summary = {
        "ç­–ç•¥": "ä½ çš„æŠ•çµ„(å¹³å‡æˆæœ¬æ³•)",
        "ç¸½æˆæœ¬(å°å¹£)": float(total_twd_cost) if 'total_twd_cost' in globals() else np.nan,
        "å¸‚å€¼(å°å¹£)": float(total_twd_value) if 'total_twd_value' in globals() else np.nan,
        "æœªå¯¦ç¾æç›Š(å°å¹£)": float(total_unrealized_pnl) if 'total_unrealized_pnl' in globals() else np.nan,
        "å·²å¯¦ç¾æç›Š(å°å¹£)": float(total_realized_pnl) if 'total_realized_pnl' in globals() else np.nan,
        "ç¸½æç›Š(å°å¹£)": float((total_unrealized_pnl if 'total_unrealized_pnl' in globals() else 0) + (total_realized_pnl if 'total_realized_pnl' in globals() else 0)),
        "å ±é…¬ç‡": float(((total_unrealized_pnl + total_realized_pnl) / total_twd_cost) if ('total_twd_cost' in globals() and total_twd_cost > 0 and 'total_unrealized_pnl' in globals() and 'total_realized_pnl' in globals()) else np.nan)
    }
    comparison_results.insert(0, base_summary)
except Exception as e:
    pass

comparison_df = pd.DataFrame(comparison_results)
# æ’ç‰ˆä¸€ä¸‹
cols_order = ["ç­–ç•¥","ç¸½æˆæœ¬(å°å¹£)","å¸‚å€¼(å°å¹£)","æœªå¯¦ç¾æç›Š(å°å¹£)","å·²å¯¦ç¾æç›Š(å°å¹£)","ç¸½æç›Š(å°å¹£)","å ±é…¬ç‡"]
comparison_df = comparison_df[cols_order]

# ===== 5) è¼¸å‡º Excelã€æŠ•è³‡æ¯”è¼ƒå ±è¡¨.xlsxã€‘ =====
compare_output_file = "/content/æŠ•è³‡æ¯”è¼ƒå ±è¡¨.xlsx"
with pd.ExcelWriter(compare_output_file, engine="xlsxwriter") as writer:
    comparison_df.to_excel(writer, sheet_name="ç¸½è¦½_ç¸¾æ•ˆæ¯”è¼ƒ", index=False)
    # é€å¼µå¯«å…¥
    for sheet_name, df_sheet in sheets.items():
        # Excel å·¥ä½œè¡¨åç¨±æœ€å¤š 31 å­—ï¼Œé˜²æ­¢éé•·æˆªæ–·
        safe_name = sheet_name[:31]
        df_sheet.to_excel(writer, sheet_name=safe_name, index=False)

print(f"âœ… æŠ•è³‡æ¯”è¼ƒå ±è¡¨å·²è¼¸å‡ºï¼š{compare_output_file}")

# è‹¥åœ¨ Colabï¼Œæä¾›ä¸‹è¼‰
try:
    from google.colab import files
    files.download(compare_output_file)
except Exception:
    pass

# ===== 6) è¢å¹•ä¸Šä¹Ÿåˆ—å‡ºç°¡çŸ­æ¯”è¼ƒçµæœ =====
print("\n============================")
print("ğŸ“Š å…­çµ„ç­–ç•¥ vs ä½ çš„æŠ•çµ„ï¼šç¸¾æ•ˆç¸½è¡¨")
print(comparison_df.to_string(index=False))

# ===== 7) åˆ†æè§’åº¦æç¤ºï¼ˆé¸è‚¡ vs Market Timingï¼‰ =====
print("""
ğŸ” è§£æå»ºè­°ï¼š
- é¸è‚¡èƒ½åŠ›ï¼šæ¯”è¼ƒã€Œé¡åƒ-SPY / é¡åƒ-0050 / é¡åƒ-2330ã€çš„å ±é…¬ç‡ vs ä½ çš„æŠ•çµ„ï¼Œ
  è‹¥é¡åƒç­–ç•¥ï¼ˆåŒæ™‚é–“åŒç¾é‡‘æµï¼‰é•·æœŸé¡¯è‘—æ›´å¥½/æ›´å·®ï¼Œå·®ç•°å¤šåŠæºè‡ªã€æ¨™çš„é¸æ“‡ã€ã€‚
- Market Timing èƒ½åŠ›ï¼šæ¯”è¼ƒã€Œé¡åƒï¼ˆåŒæ™‚é–“ï¼‰ã€èˆ‡ã€ŒDCAï¼ˆæ¯æœˆå®šé¡ï¼‰ã€å°åŒä¸€æ¨™çš„çš„å·®è·ï¼Œ
  è‹¥ä½ åŸæŠ•çµ„è¶…è¶Š DCA å¾ˆå¤šï¼Œä»£è¡¨ä½ åœ¨é€²å‡ºæ™‚é»ä¸Šæœ‰æ­£å‘è²¢ç»ï¼›åä¹‹å‰‡å¯èƒ½éœ€æª¢è¨æ™‚é»é…ç½®ã€‚
""")
